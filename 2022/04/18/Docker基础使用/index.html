<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/icon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icon.svg">
  <link rel="mask-icon" href="/images/icon.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/pink/pace-theme-material.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"he-zhifei.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.0/config.min.js"></script>

    <meta name="description" content="docker、docker compose、docker swarm、docker stack等组件相关用法，以及部署常用软件。">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker基础使用">
<meta property="og:url" content="https://he-zhifei.github.io/2022/04/18/Docker%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="Zhifei&#39;s Blog">
<meta property="og:description" content="docker、docker compose、docker swarm、docker stack等组件相关用法，以及部署常用软件。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-04-18T04:25:38.000Z">
<meta property="article:modified_time" content="2024-10-26T16:42:18.782Z">
<meta property="article:author" content="he-zhifei">
<meta property="article:tag" content="Docker">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://he-zhifei.github.io/2022/04/18/Docker%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://he-zhifei.github.io/2022/04/18/Docker%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/","path":"2022/04/18/Docker基础使用/","title":"Docker基础使用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Docker基础使用 | Zhifei's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>

  <script type="text/javascript" src="/js/my_js/click_love.js"></script>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <!-- 粘贴到这里 -->
  <!--
  <a target="_blank" rel="noopener" href="https://github.com/he-zhifei" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
  -->

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Zhifei's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">个人博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>文章</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E5%AE%89%E8%A3%85-%E5%8D%B8%E8%BD%BD"><span class="nav-text">1. 安装-卸载</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E5%8D%B8%E8%BD%BD%E6%97%A7%E7%89%88%E6%9C%AC"><span class="nav-text">1.1 卸载旧版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%AE%89%E8%A3%85%EF%BC%88repo%E6%96%B9%E5%BC%8F%EF%BC%89"><span class="nav-text">1.2 安装（repo方式）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E5%99%A8"><span class="nav-text">1.3 配置镜像加速器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E4%BB%93%E5%BA%93-%E9%95%9C%E5%83%8F-%E5%AE%B9%E5%99%A8"><span class="nav-text">2. 仓库-镜像-容器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-text">3. 常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%B8%AE%E5%8A%A9%E5%91%BD%E4%BB%A4"><span class="nav-text">3.1 帮助命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E9%95%9C%E5%83%8F%E5%91%BD%E4%BB%A4"><span class="nav-text">3.2 镜像命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%AE%B9%E5%99%A8%E5%91%BD%E4%BB%A4"><span class="nav-text">3.3 容器命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-%E5%88%9B%E5%BB%BA%E5%B9%B6%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="nav-text">3.3.1 创建并启动容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-%E6%9F%A5%E7%9C%8B%E5%AE%B9%E5%99%A8"><span class="nav-text">3.3.2 查看容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-%E9%80%80%E5%87%BA%E5%AE%B9%E5%99%A8"><span class="nav-text">3.3.3 退出容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-4-%E9%87%8D%E5%90%AF%E5%AE%B9%E5%99%A8"><span class="nav-text">3.3.4 重启容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-5-%E5%81%9C%E6%AD%A2%E5%AE%B9%E5%99%A8"><span class="nav-text">3.3.5 停止容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-6-%E5%BC%BA%E5%88%B6%E5%81%9C%E6%AD%A2%E5%AE%B9%E5%99%A8"><span class="nav-text">3.3.6 强制停止容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-7-%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8"><span class="nav-text">3.3.7 删除容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-8-%E6%8B%93%E5%B1%95%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-text">3.3.8 拓展（重点）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="nav-text">4. 容器数据卷</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-v%E5%8F%82%E6%95%B0"><span class="nav-text">4.1 -v参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-Dockerfile"><span class="nav-text">4.2 Dockerfile</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-docker%E7%BD%91%E7%BB%9C"><span class="nav-text">5. docker网络</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-docker%E5%9B%9B%E7%A7%8D%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F"><span class="nav-text">5.1 docker四种网络模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-1-host%E6%A8%A1%E5%BC%8F"><span class="nav-text">5.1.1 host模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-2-container%E6%A8%A1%E5%BC%8F"><span class="nav-text">5.1.2 container模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-3-none%E6%A8%A1%E5%BC%8F"><span class="nav-text">5.1.3 none模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-4-bridge%E6%A8%A1%E5%BC%8F"><span class="nav-text">5.1.4 bridge模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-docker%E7%BD%91%E7%BB%9C%E9%9A%94%E7%A6%BB"><span class="nav-text">5.2 docker网络隔离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-%E2%80%93link"><span class="nav-text">5.2.1 –link</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C"><span class="nav-text">5.2.2 自定义网络</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-docker-compose"><span class="nav-text">6. docker compose</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-%E5%AE%89%E8%A3%85%E3%80%81%E5%8D%87%E7%BA%A7%E3%80%81%E5%8D%B8%E8%BD%BD"><span class="nav-text">6.1 安装、升级、卸载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-docker-compose-yml"><span class="nav-text">6.2 docker-compose.yml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="nav-text">6.3 相关命令</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-docker%E9%9B%86%E7%BE%A4"><span class="nav-text">7. docker集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-docker-swarm%EF%BC%88%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%EF%BC%89"><span class="nav-text">7.1 docker swarm（集群搭建）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-docker-service%EF%BC%88%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%EF%BC%89"><span class="nav-text">7.2 docker service（服务管理）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-docker-stack%EF%BC%88%E5%A0%86%E6%A0%88%E7%AE%A1%E7%90%86%EF%BC%89"><span class="nav-text">7.3 docker stack（堆栈管理）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-compose%E3%80%81service%E3%80%81stack%E6%AF%94%E8%BE%83"><span class="nav-text">7.4 compose、service、stack比较</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E9%83%A8%E7%BD%B2%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6"><span class="nav-text">8. 部署常用软件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-%E7%A7%81%E6%9C%8D%E6%90%AD%E5%BB%BA"><span class="nav-text">8.1 私服搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-1-registry"><span class="nav-text">8.1.1 registry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-2-harbor%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="nav-text">8.1.2 harbor（推荐）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-%E5%AE%89%E8%A3%85nginx"><span class="nav-text">8.2 安装nginx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-%E5%AE%89%E8%A3%85mysql"><span class="nav-text">8.3 安装mysql</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-4-%E5%AE%89%E8%A3%85redis"><span class="nav-text">8.4 安装redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-1-%E5%8D%95%E6%9C%BA"><span class="nav-text">8.4.1 单机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-2-%E9%9B%86%E7%BE%A4%EF%BC%88%E4%B8%89%E4%B8%BB%E4%B8%89%E4%BB%8E%EF%BC%89"><span class="nav-text">8.4.2 集群（三主三从）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89%E8%87%AA%E5%AE%9A%E4%B9%89%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9Credis%E9%9B%86%E7%BE%A4"><span class="nav-text">1）自定义虚拟网络redis集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E5%8D%95%E6%9C%BA%E9%9B%86%E7%BE%A4"><span class="nav-text">2）单机集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%EF%BC%89%E5%A4%9A%E6%9C%BA%E9%9B%86%E7%BE%A4%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-text">3）多机集群（重点）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-5-%E6%90%AD%E5%BB%BAzookeeper%E9%9B%86%E7%BE%A4"><span class="nav-text">8.5 搭建zookeeper集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-6-%E9%83%A8%E7%BD%B2SpringBoot%E9%A1%B9%E7%9B%AE"><span class="nav-text">8.6 部署SpringBoot项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-6-1-docker-run"><span class="nav-text">8.6.1 docker run</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81"><span class="nav-text">1）项目源码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="nav-text">2）构建镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%EF%BC%89%E8%BF%90%E8%A1%8C%E5%B9%B6%E6%B5%8B%E8%AF%95"><span class="nav-text">3）运行并测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%EF%BC%89%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F%E5%88%B0harbor"><span class="nav-text">4）推送镜像到harbor</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-6-2-docker-compose%EF%BC%88%E5%A4%9A%E5%88%86%E7%89%87%EF%BC%89"><span class="nav-text">8.6.2 docker compose（多分片）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89docker-compose-yml"><span class="nav-text">1）docker-compose.yml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E4%BF%AE%E6%94%B9nginx%E9%85%8D%E7%BD%AE"><span class="nav-text">2）修改nginx配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%EF%BC%89%E8%BF%90%E8%A1%8C%E5%B9%B6%E6%B5%8B%E8%AF%95-1"><span class="nav-text">3）运行并测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-6-3-docker-swarm%EF%BC%88%E5%A4%9A%E8%8A%82%E7%82%B9%E5%A4%9A%E5%88%86%E7%89%87%EF%BC%89"><span class="nav-text">8.6.3 docker swarm（多节点多分片）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F"><span class="nav-text">1）拉取镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89stack-yml"><span class="nav-text">2）stack.yml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%EF%BC%89%E5%BC%80%E6%94%BE%E7%AB%AF%E5%8F%A3"><span class="nav-text">3）开放端口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4%EF%BC%89%E8%BF%90%E8%A1%8C"><span class="nav-text">4）运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="nav-text">5）测试</span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="he-zhifei"
      src="/images/profile-pic.svg">
  <p class="site-author-name" itemprop="name">he-zhifei</p>
  <div class="site-description" itemprop="description">keep it up.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/he-zhifei" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;he-zhifei" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:he-zhifei@foxmail.com" title="E-Mail → mailto:he-zhifei@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://example.com/" title="https:&#x2F;&#x2F;example.com" rel="noopener" target="_blank">友情链接</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

  <a href="https://github.com/he-zhifei" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://he-zhifei.github.io/2022/04/18/Docker%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/profile-pic.svg">
      <meta itemprop="name" content="he-zhifei">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhifei's Blog">
      <meta itemprop="description" content="keep it up.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Docker基础使用 | Zhifei's Blog">
      <meta itemprop="description" content="docker、docker compose、docker swarm、docker stack等组件相关用法，以及部署常用软件。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Docker基础使用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-18 12:25:38" itemprop="dateCreated datePublished" datetime="2022-04-18T12:25:38+08:00">2022-04-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-10-27 00:42:18" itemprop="dateModified" datetime="2024-10-27T00:42:18+08:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>50 分钟</span>
    </span>
</div>

            <div class="post-description">docker、docker compose、docker swarm、docker stack等组件相关用法，以及部署常用软件。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="1-安装-卸载"><a href="#1-安装-卸载" class="headerlink" title="1. 安装-卸载"></a>1. 安装-卸载</h1><ul>
<li>注：这里使用centos7、docker-ce-20.10.2、docker-ce-cli-20.10.2作为实践例子</li>
</ul>
<h2 id="1-1-卸载旧版本"><a href="#1-1-卸载旧版本" class="headerlink" title="1.1 卸载旧版本"></a>1.1 卸载旧版本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine docker-ce docker-ce-cli</span><br></pre></td></tr></table></figure>

<h2 id="1-2-安装（repo方式）"><a href="#1-2-安装（repo方式）" class="headerlink" title="1.2 安装（repo方式）"></a>1.2 安装（repo方式）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装yum-utils软件包（提供yum-config-manager 实用程序）</span></span><br><span class="line">sudo yum install -y yum-utils</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置稳定的存储库(这里使用阿里云的地址)，官方地址：https://download.docker.com/linux/centos/docker-ce.repo</span></span><br><span class="line">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新yum软件包索引</span></span><br><span class="line">yum makecache fast</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认安装最新版</span></span><br><span class="line">sudo yum -y install docker-ce docker-ce-cli containerd.io</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">或安装指定版本，查看可用版本（最新版在最上面）</span></span><br><span class="line">yum list docker-ce --showduplicates | sort -r</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">例如：docker-ce.x86_64      3:20.10.2-3.el7          docker-ce-stable</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定安装版本号，由第二列的分号(:)后开始到连接符(-)前结束，这里为20.10.2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令：<span class="built_in">sudo</span> yum -y install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io</span></span><br><span class="line">sudo yum -y install docker-ce-20.10.2 docker-ce-cli-20.10.2 containerd.io</span><br><span class="line"></span><br><span class="line">sudo systemctl start docker		# 启动</span><br><span class="line">sudo systemctl enable docker	# 自启动</span><br><span class="line">sudo docker run hello-world		# 运行hello-world镜像</span><br></pre></td></tr></table></figure>

<h2 id="1-3-配置镜像加速器"><a href="#1-3-配置镜像加速器" class="headerlink" title="1.3 配置镜像加速器"></a>1.3 配置镜像加速器</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">腾讯云镜像加速器：https://mirror.ccs.tencentyun.com</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">中国科学技术大学镜像：https://docker.mirrors.ustc.edu.cn</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Docker官方镜像（中国区）：https://registry.docker-cn.com</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网易云镜像加速器：https://hub-mirror.c.163.com</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">南京大学镜像加速器：https://docker.nju.edu.cn</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">阿里云镜像加速器：https://&lt;你的ID&gt;.mirror.aliyuncs.com（需登录阿里云控制台获取）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">DaoCloud镜像加速器：https://docker.m.daocloud.io</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">百度云镜像站：https://mirror.baidubce.com</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;&#x27;EOF&#x27;&gt;/etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;:</span><br><span class="line">    [</span><br><span class="line">        &quot;https://mirror.ccs.tencentyun.com&quot;,</span><br><span class="line">        &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span><br><span class="line">        &quot;https://registry.docker-cn.com&quot;,</span><br><span class="line">        &quot;https://hub-mirror.c.163.com&quot;,</span><br><span class="line">        &quot;https://docker.nju.edu.cn&quot;,</span><br><span class="line">        &quot;https://docker.m.daocloud.io&quot;,</span><br><span class="line">        &quot;https://mirror.baidubce.com&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<p>docker info（查看配置加速器是否生效，在最下面显示配置的加速器地址）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Registry Mirrors:</span><br><span class="line">具体加速器地址...</span><br></pre></td></tr></table></figure>

<h1 id="2-仓库-镜像-容器"><a href="#2-仓库-镜像-容器" class="headerlink" title="2. 仓库-镜像-容器"></a>2. 仓库-镜像-容器</h1><p>仓库：存放镜像；</p>
<p>镜像：只读的分层文件系统；</p>
<p>容器：镜像的实例；</p>
<p>若把容器比作Java对象，则镜像为Java类，仓库为方法区。</p>
<h1 id="3-常用命令"><a href="#3-常用命令" class="headerlink" title="3. 常用命令"></a>3. 常用命令</h1><h2 id="3-1-帮助命令"><a href="#3-1-帮助命令" class="headerlink" title="3.1 帮助命令"></a>3.1 帮助命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker version		# 查看docker版本</span><br><span class="line">docker info         # 查看docker详细信息</span><br><span class="line">docker --help       # 查看帮助文档</span><br></pre></td></tr></table></figure>

<h2 id="3-2-镜像命令"><a href="#3-2-镜像命令" class="headerlink" title="3.2 镜像命令"></a>3.2 镜像命令</h2> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker images [-aq]		# 查看docker镜像，a表示all，q表示只显示镜像ID，--no-trunc表示显示详细的镜像ID，--digests表示显示镜像的摘要信息</span><br><span class="line">docker images [镜像名称或镜像id:&lt;TAG&gt;]		# 查看指定镜像信息</span><br><span class="line">docker history [镜像名称或镜像id:&lt;TAG&gt;]		# 查看指定镜像构建过程信息</span><br><span class="line">docker search [Options] tomcat		# 从https://hub.docker.com/上搜索tomcat镜像，可选参数为：--help(帮助文档)，--no-tranc(详细信息)，--limit(限制搜索结果条数)，-s（显示STARS数大于指定数的记录，新版本已移除此参数）</span><br><span class="line">docker pull tomcat[:TAG]          # 不写TAG，等价于:latest，最新版本</span><br><span class="line">docker rmi [-f] hello-world[:TAG]        # 通过唯一镜像名删除镜像，-f强制删除（使用中的镜像），不指定TAG默认删除latest版本</span><br><span class="line">docker rmi [-f] 镜像ID[:TAG]       # 通过镜像ID删除镜像</span><br><span class="line">docker rmi [-f] 镜像名1[:TAG] 镜像名2[:TAG]       # 批量删除镜像</span><br><span class="line">docker rmi [-f] $(docker images -qa)              # 删除所有镜像</span><br><span class="line"></span><br><span class="line">docker build -f &lt;Dockerfile文件&gt; -t [&lt;镜像命名空间&gt;/]&lt;镜像名&gt;[:&lt;TAG&gt;] .	# 按照Dockerfile构建镜像</span><br></pre></td></tr></table></figure>

<ul>
<li>docker push相关</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录仓库</span></span><br><span class="line">docker login</span><br><span class="line">Usage:  docker login [OPTIONS] [SERVER]</span><br><span class="line">Log in to a Docker registry.</span><br><span class="line">If no server is specified, the default is defined by the daemon.</span><br><span class="line">Options:</span><br><span class="line">-p, --password string   Password</span><br><span class="line">   --password-stdin    Take the password from stdin</span><br><span class="line">-u, --username string   Username</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建并提交镜像</span></span><br><span class="line">docker commit</span><br><span class="line">Usage:  docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]</span><br><span class="line">Create a new image from a container&#x27;s changes</span><br><span class="line">Options:</span><br><span class="line">  -a, --author string    Author (e.g., &quot;John Hannibal Smith &lt;hannibal@a-team.com&gt;&quot;) 作者信息</span><br><span class="line">  -c, --change list      Apply Dockerfile instruction to the created image </span><br><span class="line">  -m, --message string   Commit message 提交信息</span><br><span class="line">  -p, --pause            Pause container during commit (default true)</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建tag</span></span><br><span class="line">docker tag</span><br><span class="line">Usage:  docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]</span><br><span class="line">Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送镜像到仓库</span></span><br><span class="line">docker push</span><br><span class="line">Usage:  docker push [OPTIONS] NAME[:TAG]</span><br><span class="line">Push an image or a repository to a registry</span><br><span class="line">Options:</span><br><span class="line">-a, --all-tags                Push all tagged images in the repository</span><br><span class="line">   --disable-content-trust   Skip image signing (default true)</span><br><span class="line">-q, --quiet                   Suppress verbose output</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">退出登录</span></span><br><span class="line">docker logout</span><br></pre></td></tr></table></figure>

<h2 id="3-3-容器命令"><a href="#3-3-容器命令" class="headerlink" title="3.3 容器命令"></a>3.3 容器命令</h2><h3 id="3-3-1-创建并启动容器"><a href="#3-3-1-创建并启动容器" class="headerlink" title="3.3.1 创建并启动容器"></a>3.3.1 创建并启动容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker run [OPTIONS] 镜像ID/镜像名称 [COMMAND] [ARG…]		# 新建并启动容器</span><br><span class="line">可选参数OPTIONS：</span><br><span class="line">--name=容器新名字:为容器指定一个名称，等号可替换成空格;</span><br><span class="line">-i:以交互模式运行容器，通常与-t同时使用;</span><br><span class="line">-t:为容器重新分配一个伪输入终端，通常与-i同时使用;</span><br><span class="line">-P:随机端口映射;</span><br><span class="line">-p:指定端口映射，有以下四种格式：ip:hostPort:containerPort、ip::containerPort、hostPort:containerPort、containerPort</span><br><span class="line">容器一旦创建后，无法在docker start中指定映射端口，若要修改端口映射，需要修改以下2点。必须先停止容器后修改，然后重启docker，再启动容器：</span><br><span class="line">（1）/var/lib/docker/containers/容器id/hostconfig.json中的：</span><br><span class="line">&quot;PortBindings&quot;:&#123;&quot;80/tcp&quot;:[&#123;&quot;HostIp&quot;:&quot;&quot;,&quot;HostPort&quot;:&quot;9999&quot;&#125;]&#125;    # 这里的80为容器端口，9999宿主端口</span><br><span class="line">（2）/var/lib/docker/containers/容器id/config.v2.json中的：</span><br><span class="line">&quot;ExposedPorts&quot;:&#123;&quot;80/tcp&quot;:&#123;&#125;&#125;      # 这里的80为容器端口</span><br><span class="line">-v 容器外目录:容器内目录[:ro]（nginx容器配置了此映射后，不会创建default.conf），:ro表示readonly只允许从宿主机单向写入操作，不允许容器对该目录做写操作</span><br><span class="line">-d 以后台守护进程的方式启动</span><br><span class="line"></span><br><span class="line">docker start 容器ID/容器名称       # 启动容器</span><br></pre></td></tr></table></figure>

<ul>
<li>通常用法：docker run -it -p 宿主端口:容器端口 -v 宿主目录:容器目录[:ro] –name&#x3D;容器名称 &lt;镜像名称或id&gt;</li>
</ul>
<h3 id="3-3-2-查看容器"><a href="#3-3-2-查看容器" class="headerlink" title="3.3.2 查看容器"></a>3.3.2 查看容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker ps [OPTIONS]         # 列出正在运行的容器</span><br><span class="line">可选参数OPTIONS：</span><br><span class="line">-q(静默模式，只显示容器编号)；</span><br><span class="line">-a(列出所有容器，包括所有状态)；</span><br><span class="line">-l(列出最近创建的1个容器，包括所有状态)；</span><br><span class="line">-n x(列出最近x个创建的容器，包括所有状态)；</span><br><span class="line">--no-tranc(不截断容器ID输出)；</span><br></pre></td></tr></table></figure>

<h3 id="3-3-3-退出容器"><a href="#3-3-3-退出容器" class="headerlink" title="3.3.3 退出容器"></a>3.3.3 退出容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exit      # 停止容器并退出，使用：docker exec -it [容器id或容器名称] /bin/bash进入容器的前提，exit会退出当前shell，但不会导致容器停止</span><br><span class="line">ctrl+p+q      # 不停止退出</span><br></pre></td></tr></table></figure>

<h3 id="3-3-4-重启容器"><a href="#3-3-4-重启容器" class="headerlink" title="3.3.4 重启容器"></a>3.3.4 重启容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart 容器ID/容器名称</span><br></pre></td></tr></table></figure>

<h3 id="3-3-5-停止容器"><a href="#3-3-5-停止容器" class="headerlink" title="3.3.5 停止容器"></a>3.3.5 停止容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop 容器ID/容器名称</span><br></pre></td></tr></table></figure>

<h3 id="3-3-6-强制停止容器"><a href="#3-3-6-强制停止容器" class="headerlink" title="3.3.6 强制停止容器"></a>3.3.6 强制停止容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker kill 容器ID/容器名称</span><br></pre></td></tr></table></figure>

<h3 id="3-3-7-删除容器"><a href="#3-3-7-删除容器" class="headerlink" title="3.3.7 删除容器"></a>3.3.7 删除容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker rm [-f] 容器ID/容器名称      # 删除容器，-f强制删除（默认只删除已停止的容器），区别rmi（i代表image）</span><br><span class="line">docker rm -f $(docker ps -qa) # 删除所有容器，-f强制删除（默认只删除已停止的容器），等同于：docker ps -qa|xargs docker rm -f</span><br></pre></td></tr></table></figure>

<h3 id="3-3-8-拓展（重点）"><a href="#3-3-8-拓展（重点）" class="headerlink" title="3.3.8 拓展（重点）"></a>3.3.8 拓展（重点）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d 镜像ID/镜像名称       # 使用后台守护进程的方式启动，如果没有交互，会启动后立马停止，可通过以下命令测试：</span><br><span class="line">docker run -d centos /bin/sh -c &quot;while true; do echo hello-world; sleep 3; done&quot;</span><br><span class="line"></span><br><span class="line">docker logs -t -f --tail 5 容器ID/容器名称       # 查看logs，t:时间戳，f: 跟踪日志输出，--tail 5：最后5条日志</span><br><span class="line">docker top 容器ID/容器名称    # 查看容器内进程</span><br><span class="line">docker inspect 容器ID/容器名称      # 查看容器内部细节</span><br><span class="line">docker attach 容器ID/容器名称       # 重新进入容器启动命令的终端，不会启动新进程</span><br><span class="line">docker exec -it 容器ID/容器名称 shell命令		# 在容器内部执行对应的shell命令，为/bin/bash时，表示在容器打开新的终端，可以启动新的进程</span><br><span class="line"></span><br><span class="line">docker cp 容器ID/容器名称:容器内文件(目录) 容器外文件(目录)    # 复制容器内文件(目录)到容器外</span><br><span class="line">docker cp 容器外文件(目录) 容器ID/容器名称:容器内文件(目录)     # 复制容器外文件(目录)到容器内</span><br></pre></td></tr></table></figure>
<h1 id="4-容器数据卷"><a href="#4-容器数据卷" class="headerlink" title="4. 容器数据卷"></a>4. 容器数据卷</h1><h2 id="4-1-v参数"><a href="#4-1-v参数" class="headerlink" title="4.1 -v参数"></a>4.1 -v参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 宿主端口:容器端口 -v 宿主目录:容器目录[:ro] --name=容器名称 &lt;镜像名称或id&gt;		# -v参数实现容器内目录与宿主机目录数据同步，:ro表示readonly只允许从宿主机单向写入操作，不允许容器对该目录做写操作。如果目录不存在，则会自动创建</span><br></pre></td></tr></table></figure>

<p> 例如：</p>
<p> docker run -it -d -p 9988:8080 -v &#x2F;opt&#x2F;docker&#x2F;tomcat-container&#x2F;webapps:&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;webapps –name&#x3D;tomcat-container tomcat</p>
<p> 可通过docker inspect [容器id或容器名称]，查看容器卷是否绑定成功，出现一下配置，则绑定成功：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&quot;HostConfig&quot;: &#123;</span><br><span class="line">            &quot;Binds&quot;: [</span><br><span class="line">                &quot;/opt/docker/tomcat-container/webapps:/usr/local/tomcat/webapps&quot;	# 宿主机目录:容器内目录</span><br><span class="line">            ]</span><br><span class="line">            </span><br><span class="line">&quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;bind&quot;,</span><br><span class="line">                &quot;Source&quot;: &quot;/opt/docker/tomcat-container/webapps&quot;,	# 宿主机目录</span><br><span class="line">                &quot;Destination&quot;: &quot;/usr/local/tomcat/webapps&quot;,		# 容器内目录</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,		# RW，true-说明容器可以读写该目录下的内容；false-只能宿主机单向写入同步到容器中</span><br><span class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">            &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="4-2-Dockerfile"><a href="#4-2-Dockerfile" class="headerlink" title="4.2 Dockerfile"></a>4.2 Dockerfile</h2><p> Dockerfile是用来构建Docker镜像的构建文件，是由一系列命令和参数构成的脚本。</p>
<ul>
<li><p>要求</p>
<ol>
<li>每条保留字指令都必须为大写字母且后面要跟随至少一个参数；</li>
<li>指令按照从上到下，顺序执行；</li>
<li>#表示注释；</li>
<li>每条指令都会创建一个新的镜像层，并对镜像进行提交；</li>
</ol>
</li>
<li><p>Dockerfile执行大致流程</p>
<ol>
<li>docker从基础镜像运行一个容器；</li>
<li>执行一条指令并对容器作出修改；</li>
<li>执行类似docker commit的操作提交一个新的镜像层；</li>
<li>基于刚提交的镜像运行一个新容器；</li>
<li>执行Dockerfile中的下一条指令直到所有指令都执行完成；</li>
</ol>
</li>
<li><p>语法</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>FROM</td>
<td>基础镜像，当前新镜像是基于哪个镜像的，语法：FROM scratch，其中scratch为基础镜像</td>
</tr>
<tr>
<td>MAINTAINER</td>
<td>镜像维护者的姓名和邮箱地址</td>
</tr>
<tr>
<td>RUN</td>
<td>容器构建时需要运行的命令，docker build时执行</td>
</tr>
<tr>
<td>EXPOSE</td>
<td>当前容器对外暴露出的端口</td>
</tr>
<tr>
<td>WORKDIR</td>
<td>创建并启动容器后，终端默认登陆的进来工作目录，一个落脚点，且作为ADD&#x2F;COPY等指令的当前目录</td>
</tr>
<tr>
<td>ARG</td>
<td>设置环境变量，仅docker build时有效</td>
</tr>
<tr>
<td>ENV</td>
<td>设置环境变量，docker build、docker run时都有效，例如：ENV MY_PATH &#x2F;usr&#x2F;mypath</td>
</tr>
<tr>
<td>ADD</td>
<td>将宿主机目录下的文件拷贝进镜像且会自动处理URL和解压tar压缩包</td>
</tr>
<tr>
<td>COPY</td>
<td>类似ADD，拷贝文件和目录到镜像中。将从构建上下文目录中&lt;源路径&gt;的文件&#x2F;目录复制到新的一层的镜像内的&lt;目标路径&gt;位置.<br>写法一：COPY src dest <br>写法二：COPY [“src”,”dest”]</td>
</tr>
<tr>
<td>VOLUME</td>
<td>容器数据卷，用于数据保存和持久化工作</td>
</tr>
<tr>
<td>CMD</td>
<td>指定一个容器启动时要运行的命令。Dockerfile中可以有多个CMD指令，但只有最后一个生效，CMD会被docker run之后的参数替换<br>CMD指令的格式和RUN 相似，也是两种格式：<br/>● shell格式：CMD &lt;命令&gt;<br/>● exec 格式：CMD [“可执行文件”，”参数1”，”参数2”…]，如果可执行文件由多个指令通过&amp;&amp;构成，需要使用shell格式，即：CMD &lt;命令1&gt; &amp;&amp; &lt;命令2&gt;<br/>● 参数列表格式：CMD [“参数1”，”参数2”…]，在指定了ENTRYPOINT 指令后，用CMD指定具体的参数，可以通过docker run后的参数覆盖，常用作可变参数使用。</td>
</tr>
<tr>
<td>ENTRYPOINT</td>
<td>指定一个容器启动时要运行的命令。ENTRYPOINT的作用和CMD几乎一样，都是在指定容器启动程序及参数，但不会被docker run后的参数覆，可以通过docker run 的–entrypoint覆盖</td>
</tr>
<tr>
<td>ONBUILD</td>
<td>当构建一个被继承的Dockerfile时运行命令，父镜像在被子继承后父镜像的onbuild被触发，例如：<br>指定了ONBUILD RUN echo “—–父镜像回调触发器—–”，则子镜像在构建时，会触发ONBUILD触发器</td>
</tr>
<tr>
<td>USER</td>
<td>指定给哪个用户和用户组，语法：USER <user>[:<group>]</td>
</tr>
<tr>
<td>.dockerignore</td>
<td>类似.gitignore</td>
</tr>
</tbody></table>
</li>
<li><p>示例一：简单案例</p>
<ol>
<li><p>创建Dockerfile文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># volume test</span><br><span class="line">FROM centos</span><br><span class="line">VOLUME [&quot;/volume1&quot;,&quot;/volume2&quot;]</span><br><span class="line">CMD echo &quot;docker build succeed!&quot;</span><br><span class="line">CMD /bin/bash</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -f Dockerfile -t zhifei/centos:1.0.0 .</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建并运行容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可通过-v指定容器卷volume1、volume2对应宿主机的目录，如不指定，会有默认宿主目录与之对应，通过docker inspect &lt;容器<span class="built_in">id</span>或容器名称&gt;查看</span></span><br><span class="line">docker run -it zhifei/centos:1.0.0</span><br></pre></td></tr></table></figure>

<p>若Docker挂载主机目录，Docker访问出现：cannot open directory . Permission denied。解决办法：在挂载目录后多加一个–privileged&#x3D;true参数。</p>
</li>
</ol>
</li>
<li><p>示例二：自定义tomcat镜像</p>
<ol>
<li><p>创建Dockerfile文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line">MAINTAINER hezhifei&lt;he-zhifei@foxmail.com&gt;</span><br><span class="line">ENV JAVA_HOME /usr/local/jdk1.8.0_201</span><br><span class="line">ENV CATALINA_HOME /usr/local/apache-tomcat-8.5.65</span><br><span class="line">ENV PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/bin</span><br><span class="line">ENV WORKSPACE /usr/local</span><br><span class="line">WORKDIR $WORKSPACE</span><br><span class="line">ADD apache-tomcat-8.5.65.tar.gz /usr/local</span><br><span class="line">ADD jdk-8u201-linux-x64.tar.gz /usr/local</span><br><span class="line">EXPOSE 8080</span><br><span class="line">CMD /usr/local/apache-tomcat-8.5.65/bin/startup.sh &amp;&amp; tail -F /usr/local/apache-tomcat-8.5.65/logs/catalina.out</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -f Dockerfile -t zhifei/tomcat:8.5.65 .</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建并运行容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d -p 7777:8080 -v /opt/docker/tomcat8.5.65/webapps:/usr/local/apache-tomcat-8.5.65/webapps -v /opt/docker/tomcat8.5.65/logs:/usr/local/apache-tomcat-8.5.65/logs --name=tomcat8.5.65 zhifei/tomcat:8.5.65</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>–volumes-from参数</p>
<p>  结论：容器之间配置信息的传递，数据卷的生命周期一直持续到没有容器使用它为止。</p>
<p>  也就是说，假设容器centos2和centos3均–volumes-from&#x3D;centos1，容器centos2的数据卷数据发生改变，容器centos1的数据卷也会发生对应的变化，同理，容器centos3的数据卷数据发生改变，容器centos1的数据卷也会发生对应的变化，相反地，容器centos1数据卷数据发生改变，同样会影响容器centos2,centos3数据卷的数据，实现了数据同步共享。当容器centos1被删除时，这种特性依然存在，因为数据卷的生命周期一直持续到没有容器使用它为止。</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">容器centos1、centos2、centos3的关系</span></span><br><span class="line">docker run -it --name=centos1 zhifei/centos:1.0.0</span><br><span class="line">docker run -it --name=centos2 --volumes-from=centos1 zhifei/centos:1.0.0</span><br><span class="line">docker run -it --name=centos3 --volumes-from=centos1 zhifei/centos:1.0.0</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="5-docker网络"><a href="#5-docker网络" class="headerlink" title="5. docker网络"></a>5. docker网络</h1><h2 id="5-1-docker四种网络模式"><a href="#5-1-docker四种网络模式" class="headerlink" title="5.1 docker四种网络模式"></a>5.1 docker四种网络模式</h2><p>原理：Docker使用Linux桥接，在宿主机虚拟一个Docker容器网桥(docker0)，Docker启动一个容器时会根据Docker网桥的网段分配给容器一个IP地址，称为Container-IP，同时Docker网桥是每个容器的默认网关。因为在同一宿主机内的容器都接入同一个网桥，这样容器之间就能够通过容器的Container-IP直接通信。Docker网桥是宿主机虚拟出来的，并不是真实存在的网络设备，外部网络是无法寻址到的，这也意味着外部网络无法通过直接Container-IP访问到容器。如果容器希望外部访问能够访问到，可以通过映射容器端口到宿主主机（端口映射），即docker run创建容器时候通过 -p 或 -P 参数来启用，访问容器的时候就通过[宿主机IP]:[容器端口]访问容器。</p>
<table>
<thead>
<tr>
<th>Docker网络模式</th>
<th>配置</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>host模式</td>
<td>-–net&#x3D;host</td>
<td>容器和宿主机共享Network namespace。</td>
</tr>
<tr>
<td>container模式</td>
<td>-–net&#x3D;container:NAME_or_ID</td>
<td>容器和另外一个容器共享Network namespace。 kubernetes中的pod就是多个容器共享一个Network namespace。</td>
</tr>
<tr>
<td>none模式</td>
<td>-–net&#x3D;none</td>
<td>容器有独立的Network namespace，但并没有对其进行任何网络设置，如分配veth pair 和网桥连接，配置IP等。</td>
</tr>
<tr>
<td>bridge模式</td>
<td>-–net&#x3D;bridge</td>
<td>docker默认</td>
</tr>
</tbody></table>
<h3 id="5-1-1-host模式"><a href="#5-1-1-host模式" class="headerlink" title="5.1.1 host模式"></a>5.1.1 host模式</h3><p>如果启动容器的时候使用host模式，那么这个容器将不会获得一个独立的Network Namespace，而是和宿主机共用一个Network Namespace。容器将不会虚拟出自己的网卡，配置自己的IP等，而是使用宿主机的IP和端口。但是，容器的其他方面，如文件系统、进程列表等还是和宿主机隔离的。使用host模式的容器可以直接使用宿主机的IP地址与外界通信，容器内部的服务端口也可以使用宿主机的端口，不需要进行NAT，host最大的优势就是网络性能比较好，但是docker host上已经使用的端口就不能再用了，网络的隔离性不好。</p>
<h3 id="5-1-2-container模式"><a href="#5-1-2-container模式" class="headerlink" title="5.1.2 container模式"></a>5.1.2 container模式</h3><p>这个模式指定新创建的容器和已经存在的一个容器共享一个 Network Namespace，而不是和宿主机共享。新创建的容器不会创建自己的网卡，配置自己的 IP，而是和一个指定的容器共享 IP、端口范围等。同样，两个容器除了网络方面，其他的如文件系统、进程列表等还是隔离的。两个容器的进程可以通过 lo 网卡设备通信。</p>
<h3 id="5-1-3-none模式"><a href="#5-1-3-none模式" class="headerlink" title="5.1.3 none模式"></a>5.1.3 none模式</h3><p>使用none模式，Docker容器拥有自己的Network Namespace，但是，并不为Docker容器进行任何网络配置。也就是说，这个Docker容器没有网卡、IP、路由等信息。需要我们自己为Docker容器添加网卡、配置IP等。</p>
<p>这种网络模式下容器只有lo回环网络，没有其他网卡。none模式可以在容器创建时通过–network&#x3D;none来指定。这种类型的网络没有办法联网，封闭的网络能很好的保证容器的安全性。</p>
<h3 id="5-1-4-bridge模式"><a href="#5-1-4-bridge模式" class="headerlink" title="5.1.4 bridge模式"></a>5.1.4 bridge模式</h3><p>当Docker进程启动时，会在主机上创建一个名为docker0的虚拟网桥，此主机上启动的Docker容器会连接到这个虚拟网桥上。虚拟网桥的工作方式和物理交换机类似，这样主机上的所有容器就通过交换机连在了一个二层网络中。从docker0子网中分配一个IP给容器使用，并设置docker0的IP地址为容器的默认网关。在主机上创建一对虚拟网卡veth pair设备，Docker将veth pair设备的一端放在新创建的容器中，并命名为eth0（容器的网卡），另一端放在主机中，以vethxxx这样类似的名字命名，并将这个网络设备加入到docker0网桥中。可以通过brctl show命令查看。bridge模式是docker的默认网络模式，不写–net参数，就是bridge模式。使用docker run -p时，docker实际是在iptables做了DNAT规则，实现端口转发功能。可以使用iptables -t nat -vnL查看。</p>
<h2 id="5-2-docker网络隔离"><a href="#5-2-docker网络隔离" class="headerlink" title="5.2 docker网络隔离"></a>5.2 docker网络隔离</h2><p>引出：默认网络情况下，docker各个容器是可以通过ip相互之间ping通的。docker虚拟网络用的是evth-pair技术，docker容器带来的网卡都是一对一对的，evth-pair 就是一对的虚拟设备接口，都是成对出现的，一端连着协议，一端彼此连接，evth-pair 就像一个桥梁，连接各种虚拟网络设备，可通过ip add查看。但是，要是希望能通过容器名称ping通，如何处理呢？</p>
<h3 id="5-2-1-–link"><a href="#5-2-1-–link" class="headerlink" title="5.2.1 –link"></a>5.2.1 –link</h3><p>首先可以通过–link &lt;需要ping通的容器名&gt;，这种做法，底层是在当前容器的hosts文件中加多了一个映射，因此，只能在当前容器中ping通被link的容器（当向ping通），局限性太大。</p>
<h3 id="5-2-2-自定义网络"><a href="#5-2-2-自定义网络" class="headerlink" title="5.2.2 自定义网络"></a>5.2.2 自定义网络</h3><ol>
<li>自定义网络，指定对应的网关、子网</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看docker network用法</span></span><br><span class="line">[root@zhifei ~]# docker network --help</span><br><span class="line">Usage:  docker network COMMAND</span><br><span class="line">Manage networks</span><br><span class="line">Commands:</span><br><span class="line">  connect     Connect a container to a network</span><br><span class="line">  create      Create a network</span><br><span class="line">  disconnect  Disconnect a container from a network</span><br><span class="line">  inspect     Display detailed information on one or more networks</span><br><span class="line">  ls          List networks</span><br><span class="line">  prune       Remove all unused networks</span><br><span class="line">  rm          Remove one or more networks</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看docker network create用法</span></span><br><span class="line">[root@zhifei ~]# docker network create --help</span><br><span class="line">Usage:  docker network create [OPTIONS] NETWORK</span><br><span class="line">Create a network</span><br><span class="line">Options:</span><br><span class="line">      --attachable           Enable manual container attachment</span><br><span class="line">      --aux-address map      Auxiliary IPv4 or IPv6 addresses used by Network driver (default map[])</span><br><span class="line">      --config-from string   The network from which to copy the configuration</span><br><span class="line">      --config-only          Create a configuration only network</span><br><span class="line">  -d, --driver string        Driver to manage the Network (default &quot;bridge&quot;)</span><br><span class="line">      --gateway strings      IPv4 or IPv6 Gateway for the master subnet</span><br><span class="line">      --ingress              Create swarm routing-mesh network</span><br><span class="line">      --internal             Restrict external access to the network</span><br><span class="line">      --ip-range strings     Allocate container ip from a sub-range</span><br><span class="line">      --ipam-driver string   IP Address Management Driver (default &quot;default&quot;)</span><br><span class="line">      --ipam-opt map         Set IPAM driver specific options (default map[])</span><br><span class="line">      --ipv6                 Enable IPv6 networking</span><br><span class="line">      --label list           Set metadata on a network</span><br><span class="line">  -o, --opt map              Set driver specific options (default map[])</span><br><span class="line">      --scope string         Control the network&#x27;s scope</span><br><span class="line">      --subnet strings       Subnet in CIDR format that represents a network segment</span><br><span class="line">      </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建网关为172.19.0.1，子网为172.19.0.0/16的网络</span></span><br><span class="line">docker network create --driver bridge --gateway 172.19.0.1 --subnet 172.19.0.0/16 mynet:172:19</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看网络</span></span><br><span class="line">[root@zhifei ~]# docker network ls</span><br><span class="line">NETWORK ID     NAME           DRIVER    SCOPE</span><br><span class="line">1327777aa23d   bridge         bridge    local</span><br><span class="line">dbfde83d1370   host           host      local</span><br><span class="line">3a283d334d07   mynet:172:19   bridge    local</span><br><span class="line">fcc4e2fc153a   none           null      local</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建容器时，通过–net指定为自定义的网络</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建mynet-tomcat01、mynet-tomcat02，指定为同一个网络mynet:172:19</span></span><br><span class="line">docker run -d -P --name mynet-tomcat01 --net mynet:172:19 tomcat</span><br><span class="line">docker run -d -P --name mynet-tomcat02 --net mynet:172:19 tomcat</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否能通过容器名称相互ping通</span></span><br><span class="line">docker exec -it mynet-tomcat01 ping mynet-tomcat02</span><br><span class="line">docker exec -it mynet-tomcat02 ping mynet-tomcat01</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">结果如下：</span></span><br><span class="line">[root@zhifei ~]# docker exec -it mynet-tomcat01 ping mynet-tomcat02</span><br><span class="line">PING mynet-tomcat02 (172.19.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.19.0.3 (172.19.0.3): icmp_seq=1 ttl=64 time=0.062 ms</span><br><span class="line">64 bytes from 172.19.0.3 (172.19.0.3): icmp_seq=2 ttl=64 time=0.078 ms</span><br><span class="line">64 bytes from 172.19.0.3 (172.19.0.3): icmp_seq=3 ttl=64 time=0.077 ms</span><br><span class="line">64 bytes from 172.19.0.3 (172.19.0.3): icmp_seq=4 ttl=64 time=0.060 ms</span><br><span class="line">^C</span><br><span class="line">--- mynet-tomcat02 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 1002ms</span><br><span class="line">rtt min/avg/max/mdev = 0.060/0.069/0.078/0.010 ms</span><br><span class="line">[root@zhifei ~]# docker exec -it mynet-tomcat02 ping mynet-tomcat01</span><br><span class="line">PING mynet-tomcat01 (172.19.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.19.0.2 (172.19.0.2): icmp_seq=1 ttl=64 time=0.041 ms</span><br><span class="line">64 bytes from 172.19.0.2 (172.19.0.2): icmp_seq=2 ttl=64 time=0.065 ms</span><br><span class="line">64 bytes from 172.19.0.2 (172.19.0.2): icmp_seq=3 ttl=64 time=0.058 ms</span><br><span class="line">64 bytes from 172.19.0.2 (172.19.0.2): icmp_seq=4 ttl=64 time=0.065 ms</span><br><span class="line">^C</span><br><span class="line">--- mynet-tomcat01 ping statistics ---</span><br><span class="line">4 packets transmitted, 4 received, 0% packet loss, time 4ms</span><br><span class="line">rtt min/avg/max/mdev = 0.041/0.057/0.065/0.011 ms</span><br><span class="line">结论：可以通过容器名称互ping</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建tomcat03、tomcat04，均不指定网络，使用默认的bridge</span></span><br><span class="line">docker run -d -P --name tomcat03 tomcat</span><br><span class="line">docker run -d -P --name tomcat04 tomcat</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看tomcat03是否能通过ip或容器名称ping通mynet-tomcat01</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">结果如下：</span></span><br><span class="line">[root@zhifei ~]# docker exec -it tomcat03 ping mynet-tomcat01</span><br><span class="line">ping: mynet-tomcat01: Name or service not known</span><br><span class="line">[root@zhifei ~]# docker exec -it mynet-tomcat01 ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">7: eth0@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 02:42:ac:13:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.19.0.2/16 brd 172.19.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@zhifei ~]# docker exec -it tomcat03 ping 172.19.0.2</span><br><span class="line">PING 172.19.0.2 (172.19.0.2) 56(84) bytes of data.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">结论：无论通过ip或者容器名称，不同网络之间的容器均不能互连。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">但有需求tomcat03必须能访问mynet-tomcat01或mynet-tomcat02，如何处理？</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将tomcat03连接到mynet:172:19网络</span></span><br><span class="line">docker network connect mynet:172:19 tomcat03</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再次通过ip或容器名称互ping，结果如下：</span></span><br><span class="line">[root@zhifei ~]# docker exec -it tomcat03 ping 172.19.0.2</span><br><span class="line">PING 172.19.0.2 (172.19.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.19.0.2: icmp_seq=1 ttl=64 time=0.114 ms</span><br><span class="line">64 bytes from 172.19.0.2: icmp_seq=2 ttl=64 time=0.077 ms</span><br><span class="line">64 bytes from 172.19.0.2: icmp_seq=3 ttl=64 time=0.077 ms</span><br><span class="line">^C</span><br><span class="line">--- 172.19.0.2 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 1001ms</span><br><span class="line">rtt min/avg/max/mdev = 0.077/0.089/0.114/0.019 ms</span><br><span class="line">[root@zhifei ~]# docker exec -it tomcat03 ping mynet-tomcat01</span><br><span class="line">PING mynet-tomcat01 (172.19.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.19.0.2 (172.19.0.2): icmp_seq=1 ttl=64 time=0.077 ms</span><br><span class="line">64 bytes from 172.19.0.2 (172.19.0.2): icmp_seq=2 ttl=64 time=0.078 ms</span><br><span class="line">^C</span><br><span class="line">--- mynet-tomcat01 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 5ms</span><br><span class="line">rtt min/avg/max/mdev = 0.077/0.077/0.078/0.008 ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">结果显示tomcat03与mynet-tomcat01或mynet-tomcat02的网络已经打通，查看网络mynet:172:19的情况</span></span><br><span class="line">[root@zhifei ~]# docker network inspect mynet:172:19</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;mynet:172:19&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;3a283d334d076ce2cb6e33837df93f81513803d30ab0c1427cb16f5ba143dae9&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2021-05-09T01:38:34.333637572+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.19.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.19.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">            &quot;13bfb5b5df886a6f7da3c45a95e30d294e1ff6b500b27aabb837826779e0dad3&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;mynet-tomcat02&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;b980f291998ac7fb20a8e4876128a7d0818933e8f428b1f943d562c0ca92a419&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:13:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.19.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;2ea9de857b594f58174b47cc34e574d710fd0827df208e0c60d18edbea6e7115&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;tomcat03&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;ec1f6d8729604333f7f8ad7cd800a4bef1e08d7a25475db16101757370ef662a&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:13:00:04&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.19.0.4/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;7aef418b208c05c76ddea422ba3add20d7e6bd3c9063ebab25dcd7eda81bd5ae&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;mynet-tomcat01&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;5d57985068f2076b676f5620bbd536c6ae7fb2daedbe4a317d8b21e9b6c368a7&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:13:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.19.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">结果表明：已经将tomcat03，加入到网络mynet:172:19中</span></span><br></pre></td></tr></table></figure>

<h1 id="6-docker-compose"><a href="#6-docker-compose" class="headerlink" title="6. docker compose"></a>6. docker compose</h1><h2 id="6-1-安装、升级、卸载"><a href="#6-1-安装、升级、卸载" class="headerlink" title="6.1 安装、升级、卸载"></a>6.1 安装、升级、卸载</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载，如果太慢，可以到github手动下载1.29.1版本的docker-compose-Linux-x86_64，再上传到/usr/local/bin，并重命名为docker-compose</span></span><br><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.29.1/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加执行权限、创建链接、查看版本</span></span><br><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line">sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose</span><br><span class="line">docker-compose --version</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">升级：如果要从Compose 1.2或更早版本进行升级，请在升级Compose之后删除或迁移现有容器。这是因为从1.3版开始，Compose使用Docker标签来跟踪容器，并且需要重新创建容器以添加标签。如果Compose检测到创建的没有标签的容器，它将拒绝运行，这样您就不会最终获得两组标签。如果要继续使用现有容器（例如，因为它们具有要保留的数据量），则可以使用Compose 1.5.x通过以下命令迁移它们：</span></span><br><span class="line">docker-compose migrate-to-labels</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">卸载</span></span><br><span class="line">sudo rm /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<h2 id="6-2-docker-compose-yml"><a href="#6-2-docker-compose-yml" class="headerlink" title="6.2 docker-compose.yml"></a>6.2 docker-compose.yml</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">大致分为三层：</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.docker compose版本层，https://docs.docker.com/compose/compose-file/compose-file-v3/可查看docker不同版本对应的docker compose版本</span></span><br><span class="line">version:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 服务层</span></span><br><span class="line">services:	</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. 其它配置，例如网络、卷、全局配置</span></span><br><span class="line">volumes:</span><br><span class="line">networks:</span><br><span class="line">configs:</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">version: &quot;3.9&quot;</span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    build: .</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;5000:5000&quot;</span><br><span class="line">  redis:</span><br><span class="line">    image: &quot;redis:alpine&quot;</span><br></pre></td></tr></table></figure>

<h2 id="6-3-相关命令"><a href="#6-3-相关命令" class="headerlink" title="6.3 相关命令"></a>6.3 相关命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把jar包、Dockerfile、docker-compose.yml放到同一目录下。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">up启动，down停止；--build启动前docker build；-d后台启动；--scale指定节点数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">例如这里启动2个节点：docker-compose up --build -d --scale demo=2</span></span><br><span class="line">docker-compose up [--build] [-d] [--scale &lt;服务名称&gt;=&lt;服务节点数&gt;]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">start-开启；stop-停止；restart-重启；up-创建和开启；down-停止和移除</span></span><br><span class="line">docker-compose start/stop/restart/up/down</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看日志</span></span><br><span class="line">[root@he ~]# docker-compose logs --help</span><br><span class="line">View output from containers.</span><br><span class="line"></span><br><span class="line">Usage: logs [options] [--] [SERVICE...]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">    --no-color              Produce monochrome output.</span><br><span class="line">    -f, --follow            Follow log output.</span><br><span class="line">    -t, --timestamps        Show timestamps.</span><br><span class="line">    --tail=&quot;all&quot;            Number of lines to show from the end of the logs</span><br><span class="line">                            for each container.</span><br><span class="line">    --no-log-prefix         Don&#x27;t print prefix in logs.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看帮助命令</span></span><br><span class="line">[root@he ~]# docker-compose --help</span><br><span class="line">Define and run multi-container applications with Docker.</span><br><span class="line">Usage:</span><br><span class="line">  docker-compose [-f &lt;arg&gt;...] [--profile &lt;name&gt;...] [options] [--] [COMMAND] [ARGS...]</span><br><span class="line">  docker-compose -h|--help</span><br><span class="line">Options:</span><br><span class="line">  -f, --file FILE             Specify an alternate compose file</span><br><span class="line">                              (default: docker-compose.yml)</span><br><span class="line">  -p, --project-name NAME     Specify an alternate project name</span><br><span class="line">                              (default: directory name)</span><br><span class="line">  --profile NAME              Specify a profile to enable</span><br><span class="line">  -c, --context NAME          Specify a context name</span><br><span class="line">  --verbose                   Show more output</span><br><span class="line">  --log-level LEVEL           Set log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)</span><br><span class="line">  --ansi (never|always|auto)  Control when to print ANSI control characters</span><br><span class="line">  --no-ansi                   Do not print ANSI control characters (DEPRECATED)</span><br><span class="line">  -v, --version               Print version and exit</span><br><span class="line">  -H, --host HOST             Daemon socket to connect to</span><br><span class="line"></span><br><span class="line">  --tls                       Use TLS; implied by --tlsverify</span><br><span class="line">  --tlscacert CA_PATH         Trust certs signed only by this CA</span><br><span class="line">  --tlscert CLIENT_CERT_PATH  Path to TLS certificate file</span><br><span class="line">  --tlskey TLS_KEY_PATH       Path to TLS key file</span><br><span class="line">  --tlsverify                 Use TLS and verify the remote</span><br><span class="line">  --skip-hostname-check       Don&#x27;t check the daemon&#x27;s hostname against the</span><br><span class="line">                              name specified in the client certificate</span><br><span class="line">  --project-directory PATH    Specify an alternate working directory</span><br><span class="line">                              (default: the path of the Compose file)</span><br><span class="line">  --compatibility             If set, Compose will attempt to convert keys</span><br><span class="line">                              in v3 files to their non-Swarm equivalent (DEPRECATED)</span><br><span class="line">  --env-file PATH             Specify an alternate environment file</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  build              Build or rebuild services</span><br><span class="line">  config             Validate and view the Compose file</span><br><span class="line">  create             Create services</span><br><span class="line">  down               Stop and remove resources</span><br><span class="line">  events             Receive real time events from containers</span><br><span class="line">  exec               Execute a command in a running container</span><br><span class="line">  help               Get help on a command</span><br><span class="line">  images             List images</span><br><span class="line">  kill               Kill containers</span><br><span class="line">  logs               View output from containers</span><br><span class="line">  pause              Pause services</span><br><span class="line">  port               Print the public port for a port binding</span><br><span class="line">  ps                 List containers</span><br><span class="line">  pull               Pull service images</span><br><span class="line">  push               Push service images</span><br><span class="line">  restart            Restart services</span><br><span class="line">  rm                 Remove stopped containers</span><br><span class="line">  run                Run a one-off command</span><br><span class="line">  scale              Set number of containers for a service</span><br><span class="line">  start              Start services</span><br><span class="line">  stop               Stop services</span><br><span class="line">  top                Display the running processes</span><br><span class="line">  unpause            Unpause services</span><br><span class="line">  up                 Create and start containers</span><br><span class="line">  version            Show version information and quit</span><br></pre></td></tr></table></figure>

<h1 id="7-docker集群"><a href="#7-docker集群" class="headerlink" title="7. docker集群"></a>7. docker集群</h1><h2 id="7-1-docker-swarm（集群搭建）"><a href="#7-1-docker-swarm（集群搭建）" class="headerlink" title="7.1 docker swarm（集群搭建）"></a>7.1 docker swarm（集群搭建）</h2><ol>
<li>端口说明</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 摘自：https://stackoverflow.com/questions/62580470/add-a-vm-running-ubuntu-as-a-worker-node-in-docker-swarm</span><br><span class="line">The network ports required for a Docker Swarm to function properly are:</span><br><span class="line">TCP port 2376 for secure Docker client communication. This port is required for Docker Machine to work. Docker Machine is used to orchestrate Docker hosts.</span><br><span class="line">TCP port 2377. This port is used for communication between the nodes of a Docker Swarm or cluster. It only needs to be opened on manager nodes.</span><br><span class="line">TCP and UDP port 7946 for communication among nodes (container network discovery).</span><br><span class="line">UDP port 4789 for overlay network traffic (container ingress networking).</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>搭建过程</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里使用5台机器，3主2从（3个管理节点、2个工作节点），管理节点可以执行管理相关指令</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Raft一致性协议：超过半数才能提供正常服务，swarm的管理节点的leader节点正是如此，3个管理节点，允许宕机1个管理节点</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">管理节点开放的端口：</span></span><br><span class="line">firewall-cmd --zone=public --add-port=2376/tcp --add-port=2377/tcp --add-port=7946/tcp --add-port=7946/udp --add-port=4789/udp --permanent &amp;&amp; firewall-cmd --reload &amp;&amp; firewall-cmd --list-ports</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">工作节点开放的端口（不需要开放2377/tcp）：</span></span><br><span class="line">firewall-cmd --zone=public --add-port=2376/tcp --add-port=7946/tcp --add-port=7946/udp --add-port=4789/udp --permanent &amp;&amp; firewall-cmd --reload &amp;&amp; firewall-cmd --list-ports</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化集群，执行后当前节点为管理节点。</span></span><br><span class="line">docker swarm init --advertise-addr &lt;要成为管理节点的其中一个IP&gt;</span><br><span class="line">[root@localhost ~]# docker swarm init --advertise-addr &lt;具体IP&gt;</span><br><span class="line">Swarm initialized: current node (zmnhrsdxyexkfk8dvqcgsf5qv) is now a manager.</span><br><span class="line">To add a worker to this swarm, run the following command（提示执行如下命令，将节点添加到集群，并成为工作节点）:</span><br><span class="line">    docker swarm join --token SWMTKN-1-xxx port:ip</span><br><span class="line">To add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.（在当前节点执行这条命令，返回结果中的命令用来添加管理节点，类似上面的添加工作节点的命令。）</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查看节点情况</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在管理节点上查看，工作节点无法使用管理相关的指令，结果ID后带*的为当前服务器节点信息</span></span><br><span class="line">[root@localhost ~]# docker node ls</span><br><span class="line">ID                            HOSTNAME                STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">e4kl69tmtrm2ws0u1aw7x0gri     localhost.localdomain   Ready     Active         Reachable        20.10.6</span><br><span class="line">uega8ry9ivqqwx1v6jj781ckz     localhost.localdomain   Ready     Active                          20.10.6</span><br><span class="line">wsv43jyd2a37qdnu9cd5gcbpe     localhost.localdomain   Ready     Active         Reachable        20.10.6</span><br><span class="line">ymd6kpxd1tk4py7xgbxf42huh     localhost.localdomain   Ready     Active                          20.10.6</span><br><span class="line">zmnhrsdxyexkfk8dvqcgsf5qv *   localhost.localdomain   Ready     Active         Leader           20.10.6</span><br></pre></td></tr></table></figure>

<h2 id="7-2-docker-service（服务管理）"><a href="#7-2-docker-service（服务管理）" class="headerlink" title="7.2 docker service（服务管理）"></a>7.2 docker service（服务管理）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker service --<span class="built_in">help</span></span></span><br><span class="line">[root@localhost ~]# docker service --help</span><br><span class="line">Usage:  docker service COMMAND</span><br><span class="line">Manage services</span><br><span class="line">Commands:</span><br><span class="line">  create      Create a new service</span><br><span class="line">  inspect     Display detailed information on one or more services</span><br><span class="line">  logs        Fetch the logs of a service or task</span><br><span class="line">  ls          List services</span><br><span class="line">  ps          List the tasks of one or more services</span><br><span class="line">  rm          Remove one or more services</span><br><span class="line">  rollback    Revert changes to a service&#x27;s configuration</span><br><span class="line">  scale       Scale one or multiple replicated services</span><br><span class="line">  update      Update a service</span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建服务，docker service create --<span class="built_in">help</span>，相比docker run，它能够扩缩容器。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于replicas can only be used with replicated mode，global模式也就是无法扩缩容，每个节点均只有一个服务容器，默认replicated模式。</span></span><br><span class="line">docker service create -p 10000:80 --name my-nginx [--mode replicated|global] nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看服务</span></span><br><span class="line">docker service ls</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">扩容为8个副本，在每台机器上docker ps查看容器具体在哪台机器上启动</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方法一：</span></span><br><span class="line">docker service update --replicas 8 my-nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方法二：</span></span><br><span class="line">docker service scale my-nginx=8</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问服务</span></span><br><span class="line">curl &lt;集群任一IP&gt;:10000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移除服务</span></span><br><span class="line">docker service rm my-nginx</span><br></pre></td></tr></table></figure>

<h2 id="7-3-docker-stack（堆栈管理）"><a href="#7-3-docker-stack（堆栈管理）" class="headerlink" title="7.3 docker stack（堆栈管理）"></a>7.3 docker stack（堆栈管理）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker stack --<span class="built_in">help</span></span></span><br><span class="line">[root@localhost ~]# docker stack --help</span><br><span class="line">Usage:  docker stack [OPTIONS] COMMAND</span><br><span class="line">Manage Docker stacks</span><br><span class="line">Options:</span><br><span class="line">      --orchestrator string   Orchestrator to use (swarm|kubernetes|all)</span><br><span class="line">Commands:</span><br><span class="line">  deploy      Deploy a new stack or update an existing stack</span><br><span class="line">  ls          List stacks</span><br><span class="line">  ps          List the tasks in the stack</span><br><span class="line">  rm          Remove one or more stacks</span><br><span class="line">  services    List the services in the stack</span><br><span class="line">Run &#x27;docker stack COMMAND --help&#x27; for more information on a command.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker stack deploy帮助命令</span></span><br><span class="line">[root@localhost ~]# docker stack deploy --help</span><br><span class="line">Usage:  docker stack deploy [OPTIONS] STACK</span><br><span class="line">Deploy a new stack or update an existing stack</span><br><span class="line">Aliases:</span><br><span class="line">  deploy, up</span><br><span class="line">Options:</span><br><span class="line">  -c, --compose-file strings   Path to a Compose file, or &quot;-&quot; to read from stdin</span><br><span class="line">      --orchestrator string    Orchestrator to use (swarm|kubernetes|all)</span><br><span class="line">      --prune                  Prune services that are no longer referenced</span><br><span class="line">      --resolve-image string   Query the registry to resolve image digest and supported platforms</span><br><span class="line">                               (&quot;always&quot;|&quot;changed&quot;|&quot;never&quot;) (default &quot;always&quot;)</span><br><span class="line">      --with-registry-auth     Send registry authentication details to Swarm agents</span><br><span class="line">      </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群启动或更新（也就可以通过docker-compose.yml来修改分片数量），集群管理命令，需要在管理节点执行，摘自：https://docs.docker.com/engine/reference/commandline/stack_deploy/</span></span><br><span class="line">docker stack deploy -c docker-compose.yml &lt;自定义stack名称&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出stack</span></span><br><span class="line">docker stack ls</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看指定stack中的services</span></span><br><span class="line">docker stack services &lt;stack名称&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有service</span></span><br><span class="line">docker service ls</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有节点分片的日志</span></span><br><span class="line">docker service logs &lt;日志id&gt;</span><br><span class="line">[root@localhost ~]# docker service logs --help</span><br><span class="line">Usage:  docker service logs [OPTIONS] SERVICE|TASK</span><br><span class="line">Fetch the logs of a service or task</span><br><span class="line">Options:</span><br><span class="line">      --details        Show extra details provided to logs</span><br><span class="line">  -f, --follow         Follow log output</span><br><span class="line">      --no-resolve     Do not map IDs to Names in output</span><br><span class="line">      --no-task-ids    Do not include task IDs in output</span><br><span class="line">      --no-trunc       Do not truncate output</span><br><span class="line">      --raw            Do not neatly format logs</span><br><span class="line">      --since string   Show logs since timestamp (e.g. 2013-01-02T13:23:37Z) or relative (e.g. 42m for 42 minutes)</span><br><span class="line">  -n, --tail string    Number of lines to show from the end of the logs (default &quot;all&quot;)</span><br><span class="line">  -t, --timestamps     Show timestamps</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看stack启动错误日志</span></span><br><span class="line">docker stack ps &lt;stack名称&gt; --no-trunc</span><br></pre></td></tr></table></figure>

<h2 id="7-4-compose、service、stack比较"><a href="#7-4-compose、service、stack比较" class="headerlink" title="7.4 compose、service、stack比较"></a>7.4 compose、service、stack比较</h2><ul>
<li>docker compose：需要额外安装，用于镜像构建、容器编排，只能用于单机，可指定分片数。</li>
<li>docker service：不需要额外安装，用于运行容器，相对docker run，可指定分片数，结合docker swarm可实现多机器集群部署。</li>
<li>docker stack：不需要额外安装，用于容器编排（通过docker-compose.yml），结合docker swarm可实现多机器集群部署，需要预先构建或拉取镜像。不支持第2版的yml配置，不支持docker-compose中的配置：build、cgroup_parent、container_name、devices、tmpfs、external_links、links、network_mode、restart、security_opt、userns_mode。（集群下的多个容器服务编排）</li>
</ul>
<h1 id="8-部署常用软件"><a href="#8-部署常用软件" class="headerlink" title="8. 部署常用软件"></a>8. 部署常用软件</h1><h2 id="8-1-私服搭建"><a href="#8-1-私服搭建" class="headerlink" title="8.1 私服搭建"></a>8.1 私服搭建</h2><h3 id="8-1-1-registry"><a href="#8-1-1-registry" class="headerlink" title="8.1.1 registry"></a>8.1.1 registry</h3><ol>
<li>证书目录、认证信息目录、仓库数据卷目录的创建，并配置hosts（域名：registry.loc）</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/docker/registry/auth /opt/docker/registry/certs /opt/docker/registry/registry</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>认证信息创建</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/docker/registry</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果原本存在htpasswd文件，则用&gt;&gt;进行追加，这里的testuser为用户名，testpassword为用户密码</span></span><br><span class="line">docker run --entrypoint htpasswd httpd:2 -Bbn testuser testpassword &gt; auth/htpasswd		</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>证书的生成</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成证书私钥(key)</span></span><br><span class="line">openssl genrsa -out domain.key 4096</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成自签署证书(crt)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">openssl req -new -x509 -days 3650 -key domain.key -out domain.crt</span></span><br><span class="line">openssl req -new -x509 -days 3650 -subj &quot;/C=CN/ST=GD/L=GZ/O=org/OU=orgUnit/CN=registry.loc&quot; -key domain.key -out domain.crt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把证书文件移到/opt/docker/registry/certs下，最终在容器启动时，同步到容器中</span></span><br><span class="line">mv domain.* certs/</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>启动容器</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-p 5000:5000 \</span><br><span class="line">--restart=always \</span><br><span class="line">--name registry \</span><br><span class="line">-v /opt/docker/registry/auth:/auth \</span><br><span class="line">-e &quot;REGISTRY_AUTH=htpasswd&quot; \</span><br><span class="line">-e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot; \</span><br><span class="line">-e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \</span><br><span class="line">-v /opt/docker/registry/certs:/certs \</span><br><span class="line">-v /opt/docker/registry/registry:/var/lib/registry \</span><br><span class="line">-e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \</span><br><span class="line">-e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \</span><br><span class="line">registry:2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以通过这个参数控制registry容器EXPOSE的端口，这里不配置</span></span><br><span class="line">-e REGISTRY_HTTP_ADDR=0.0.0.0:5000 \</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>修改配置，使其支持自生成的证书</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Ⅰ.方法1：修改/etc/docker/daemon.json，在registry-mirrors节点同层级后添加&quot;insecure-registries&quot;:[&quot;registry.loc:5000&quot;]</span><br><span class="line">Ⅱ.方法2：修改/usr/lib/systemd/system/docker.service，在ExecStart的命令后面添加参数--insecure-registry registry.loc:5000</span><br><span class="line">最后，执行：sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart docker 进行重新加载并重启。</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>测试push到私服</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取hello-world镜像，以做测试</span></span><br><span class="line">docker pull hello-world			</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为hello-world打tag，registry.loc:5000为私服host:ip</span></span><br><span class="line">docker tag hello-world registry.loc:5000/hw		</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">把打了tag的镜像push到私服中</span></span><br><span class="line">docker push registry.loc:5000/hw</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">提示还没认证：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Using default tag: latest</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">The push refers to repository [registry.loc:5000/hw]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">f22b99068db9: Preparing</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">no basic auth credentials</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录到私服</span></span><br><span class="line">docker login registry.loc:5000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">正确输入用户名密码后，提示登录成功：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Username: testuser</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Password:</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">WARNING! Your password will be stored unencrypted <span class="keyword">in</span> /root/.docker/config.json.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Configure a credential helper to remove this warning. See</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Login Succeeded</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新push</span></span><br><span class="line">docker push registry.loc:5000/hw</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看私服的镜像，或者在浏览器打开https://registry.loc:5000/v2/_catalog</span></span><br><span class="line">curl --user testuser:testpassword https://registry.loc:5000/v2/_catalog --insecure</span><br></pre></td></tr></table></figure>

<h3 id="8-1-2-harbor（推荐）"><a href="#8-1-2-harbor（推荐）" class="headerlink" title="8.1.2 harbor（推荐）"></a>8.1.2 harbor（推荐）</h3><p> 说明这里使用的是harbor-offline-installer-v2.4.2.tgz（addr: <a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases/tag/v2.4.2">Release v2.4.2 · goharbor&#x2F;harbor · GitHub</a>），要求</p>
<p> 硬件：cpu2<del>4、内存4</del>8GB、硬盘40~160GB</p>
<p> 软件：Docker 17.06.0-ce+ 、Docker Compose 1.18.0+ 、Openssl</p>
<ol>
<li>把下载到的harbor-offline-installer-v2.4.2.tgz进行解压，并配置hosts（域名：harbor.loc）</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf harbor-offline-installer-v2.4.2.tgz -C /opt</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>开放端口并查看端口，这里使用的是https，因此开放443</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=443/tcp --permanent &amp;&amp; firewall-cmd --reload &amp;&amp; firewall-cmd --zone=public --list-ports</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>配置https</li>
</ol>
<ul>
<li>生成CA证书密钥、CA证书、服务器证书密钥、服务器证书，也可以使用 <a href="https://he-zhifei.github.io/2021/07/26/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4(centos)/#Openssl%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6">Openssl生成证书| Zhifei’s Blog </a> 替代。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 CA 证书私钥</span></span><br><span class="line">openssl genrsa -out ca.key 4096</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 CA 证书</span></span><br><span class="line">openssl req -x509 -new -nodes -sha512 -days 3650 \</span><br><span class="line"> -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.loc&quot; \</span><br><span class="line"> -key ca.key \</span><br><span class="line"> -out ca.crt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成服务器证书私钥</span></span><br><span class="line">openssl genrsa -out harbor.loc.key 4096</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成服务器证书签名请求 （CSR）</span></span><br><span class="line">openssl req -sha512 -new \</span><br><span class="line">    -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=harbor.loc&quot; \</span><br><span class="line">    -key harbor.loc.key \</span><br><span class="line">    -out harbor.loc.csr</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 x509 v3 扩展文件</span></span><br><span class="line">cat &gt; v3.ext &lt;&lt;-EOF</span><br><span class="line">authorityKeyIdentifier=keyid,issuer</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">extendedKeyUsage = serverAuth</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1=harbor.loc</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用该文件v3.ext为 Harbor 主机生成证书</span></span><br><span class="line">openssl x509 -req -sha512 -days 3650 \</span><br><span class="line">    -extfile v3.ext \</span><br><span class="line">    -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -in harbor.loc.csr \</span><br><span class="line">    -out harbor.loc.crt</span><br></pre></td></tr></table></figure>

<ul>
<li>配置证书</li>
</ul>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将服务器证书和密钥复制到 Harbor 主机上的证书文件夹中</span></span><br><span class="line">mkdir -p /data/cert/</span><br><span class="line">cp harbor.loc.crt harbor.loc.key /data/cert/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">crt转换为cert</span></span><br><span class="line">openssl x509 -inform PEM -in harbor.loc.crt -out harbor.loc.cert</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将服务器证书、密钥和 CA 证书复制到 Harbor 主机上的 Docker 证书文件夹中</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用默认的443端口，则文件夹名不需要加:443，否则需要加上具体的端口号，即：/etc/docker/certs.d/harbor.loc:port</span></span><br><span class="line">mkdir -p /etc/docker/certs.d/harbor.loc/</span><br><span class="line">cp harbor.loc.cert harbor.loc.key ca.crt /etc/docker/certs.d/harbor.loc/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启docker服务</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从模板文件上创建harbor.yml</span></span><br><span class="line">cp /opt/harbor/harbor.yml.tmpl /opt/harbor/harbor.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改如下harbor配置，具体参数说明https://goharbor.io/docs/2.4.0/install-config/configure-yml-file/</span></span><br><span class="line">vim /opt/harbor/harbor.yml</span><br><span class="line">hostname: harbor.loc</span><br><span class="line">https:</span><br><span class="line">  certificate: /data/cert/harbor.loc.crt</span><br><span class="line">  private_key: /data/cert/harbor.loc.key</span><br><span class="line">:wq</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到hadbor根目录</span></span><br><span class="line">cd /opt/harbor/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行脚本以启用 HTTPS</span></span><br><span class="line">./prepare</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建、启动harbor相关容器</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止、移除，数据保留在文件系统中，并不会丢失。</span></span><br><span class="line">docker-compose down -v</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">正常开启/停止/重启命令使用</span></span><br><span class="line">docker-compose start/stop/restart</span><br><span class="line"></span><br><span class="line">重点注意：</span><br><span class="line">1.启动后harbor的各个容器数据保留在/data下；</span><br><span class="line">2./data/cert/下的证书是给harbor用的，而/etc/docker/certs.d/harbor.loc[:port]/是给docker用的。也就是说，假如使用的是自己创建的证书，在每一个有docker客户端的地方都需要创建这样的文件夹，存放这些证书，同时也需要配置hosts；</span><br><span class="line">3.若docker客户端没有配置证书（正常情况客户端需要配置证书），则需要增加如下配置：</span><br><span class="line">	Ⅰ.方法1：修改/etc/docker/daemon.json，在registry-mirrors节点同层级后添加&quot;insecure-registries&quot;:[&quot;harbor.loc&quot;]</span><br><span class="line">	Ⅱ.方法2：修改/usr/lib/systemd/system/docker.service，在ExecStart的命令后面添加参数--insecure-registry harbor.loc</span><br><span class="line">	最后，执行：sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart docker 进行重新加载并重启。</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置harbor组件间TLS，即<a target="_blank" rel="noopener" href="https://goharbor.io/docs/2.4.0/install-config/configure-internal-tls/">组件之间使用https进行通信</a>。（建议，非必须）</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建证书保存路径</span></span><br><span class="line">mkdir -p /opt/harbor/internal-tls/certs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用goharbor/prepare:v2.4.2自动生成各个证书</span></span><br><span class="line">docker run -v /:/hostfs goharbor/prepare:v2.4.2 gencert -p /opt/harbor/internal-tls/certs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置项</span></span><br><span class="line">vim /opt/harbor/harbor.yml</span><br><span class="line">internal_tls:</span><br><span class="line">  enabled: true</span><br><span class="line">  dir: /opt/harbor/internal-tls/certs</span><br><span class="line">:wq</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启harbor</span></span><br><span class="line">docker-compose down -v</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>访问harbor，访问：<a target="_blank" rel="noopener" href="https://harbor.loc,默认用户名admin、密码harbor12345,默认有library项目,或创建新项目(push时用到)./">https://harbor.loc，默认用户名admin、密码Harbor12345，默认有library项目，或创建新项目（push时用到）。</a></p>
</li>
<li><p>测试docker push</p>
</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录私服</span></span><br><span class="line">docker login harbor.loc -u admin -p Harbor12345</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动并创建容器</span></span><br><span class="line">docker run -it --name hw hello-world</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">提交容器，构建成harbor.loc/library/hw:v1.0.0，harbor.loc-私服地址，library-项目名称，hw-镜像名称，v1.0.0-tag</span></span><br><span class="line">docker commit -a &quot;submit&quot; -m &quot;test&quot; hw harbor.loc/library/hw:v1.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">tag指令：docker tag SOURCE_IMAGE[:TAG] harbor.loc/library/REPOSITORY[:TAG]</span></span><br><span class="line">docker tag harbor.loc/library/hw:v1.0.0 harbor.loc/library/hw-tag:v1.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">push指令：docker push harbor.loc/library/REPOSITORY[:TAG]</span></span><br><span class="line">docker push harbor.loc/library/hw:v1.0.0			# 没打tag</span><br><span class="line">docker push harbor.loc/library/hw-tag:v1.0.0		# 打tag</span><br></pre></td></tr></table></figure>

<h2 id="8-2-安装nginx"><a href="#8-2-安装nginx" class="headerlink" title="8.2 安装nginx"></a>8.2 安装nginx</h2><ol>
<li>保存默认的default.conf</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/docker/nginx/conf.d &amp;&amp; cat &lt;&lt;&#x27;EOF&#x27;&gt;/opt/docker/nginx/conf.d/default.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    listen  [::]:80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    proxy_pass   http://127.0.0.1;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    root           html;</span><br><span class="line">    #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    #    fastcgi_index  index.php;</span><br><span class="line">    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">    #    include        fastcgi_params;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">    # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">    # concurs with nginx&#x27;s one</span><br><span class="line">    #</span><br><span class="line">    #location ~ /\.ht &#123;</span><br><span class="line">    #    deny  all;</span><br><span class="line">    #&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>运行容器</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -it -p 8080:80 --restart=always -v /opt/docker/nginx/conf.d:/etc/nginx/conf.d -v /opt/docker/nginx/logs:/var/log/nginx --name=nginx nginx</span><br></pre></td></tr></table></figure>

<h2 id="8-3-安装mysql"><a href="#8-3-安装mysql" class="headerlink" title="8.3 安装mysql"></a>8.3 安装mysql</h2><ol>
<li>从docker hub上拉取mysql:5.7</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建默认的mysql配置文件my.cnf</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;&#x27;EOF&#x27;&gt;/opt/docker/mysql5.7/conf/my.cnf</span><br><span class="line">[client]</span><br><span class="line">port=3306</span><br><span class="line">socket=/tmp/mysql.sock          #windows下不需要此项配置</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">指定通信socket文件位置，windows下不需要此项配置</span></span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">忽略客户端字符集设置信息，使用服务端的字符集</span></span><br><span class="line">skip-character-set-client-handshake=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">服务段字符集</span></span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">排序规则</span></span><br><span class="line">collation-server=utf8mb4_unicode_ci</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">默认存储引擎</span></span><br><span class="line">default-storage-engine=INNODB</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sql模式</span></span><br><span class="line">sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">0-表名存储为给定的大小和比较是区分大小写的（unix默认）；1-表名存储在磁盘是小写的，但是比较的时候是不区分大小写（windows默认）；2-表名存储为给定的大小写但是比较的时候是小写的（macOS默认）</span></span><br><span class="line">lower_case_table_names=1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">最大连接数（范围：1-100000，默认151）</span></span><br><span class="line">max_connections=151</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建并运行mysql容器</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3306:3306 -d -v /opt/docker/mysql5.7/conf:/etc/mysql -v /opt/docker/mysql5.7/logs:/var/log/mysql -v /opt/docker/mysql5.7/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --name=mysql5.7 mysql:5.7</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>开放服务器端口</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=3306/tcp --permanent &amp;&amp; firewall-cmd --reload &amp;&amp; firewall-cmd --list-ports</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>数据库全局备份（非必须）</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec &lt;数据库服务器容器id或名称&gt; sh -c &#x27;exec mysqldump --all-databases -uroot -p&quot;123456&quot;&#x27; &gt; ~/all-databases-backup.sql</span><br></pre></td></tr></table></figure>

<h2 id="8-4-安装redis"><a href="#8-4-安装redis" class="headerlink" title="8.4 安装redis"></a>8.4 安装redis</h2><h3 id="8-4-1-单机"><a href="#8-4-1-单机" class="headerlink" title="8.4.1 单机"></a>8.4.1 单机</h3><ol>
<li>从docker hub上拉取redis</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull redis:5.0.12</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建并运行redis容器</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 6379:6379 -d -v /opt/docker/redis5.0.12/conf:/etc/redis/conf -v /opt/docker/redis5.0.12/data:/data --name=redis5.0.12 redis:5.0.12 redis-server /etc/redis/conf --appendonly yes</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过客户端连接上redis服务器</li>
</ol>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it &lt;redis服务器容器id或名称&gt; redis-cli</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>在宿主机的 &#x2F;opt&#x2F;docker&#x2F;redis5.0.12&#x2F;conf&#x2F;redis.conf 中保存redis配置。</li>
</ol>
<h3 id="8-4-2-集群（三主三从）"><a href="#8-4-2-集群（三主三从）" class="headerlink" title="8.4.2 集群（三主三从）"></a>8.4.2 集群（三主三从）</h3><h4 id="1）自定义虚拟网络redis集群"><a href="#1）自定义虚拟网络redis集群" class="headerlink" title="1）自定义虚拟网络redis集群"></a>1）自定义虚拟网络redis集群</h4><ul>
<li>集群说明：这里使用的子网为172.20.0.0&#x2F;16，仅适合在客户端与服务端在同一台服务器的情况，外网不能直接访问</li>
</ul>
<ol>
<li>创建集群的网络</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge --gateway 172.20.0.1 --subnet 172.20.0.0/16 redis-cluster</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成6个节点的配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">for num in $(seq 1 6); \</span><br><span class="line">do \</span><br><span class="line">mkdir -p /opt/docker/redis/node-$&#123;num&#125;/conf</span><br><span class="line">touch /opt/docker/redis/node-$&#123;num&#125;/conf/redis-cluster.conf</span><br><span class="line">cat &lt;&lt;&#x27;EOF&#x27;&gt;/opt/docker/redis/node-$&#123;num&#125;/conf/redis-cluster.conf</span><br><span class="line">port 6379</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.20.0.1$&#123;num&#125;</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly yes</span><br><span class="line">masterauth passwd</span><br><span class="line">requirepass passwd</span><br><span class="line">EOF</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动6个节点的redis</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for num in $(seq 1 6); \</span><br><span class="line">do \</span><br><span class="line">docker run -p 637$&#123;num&#125;:6379 -p 1637$&#123;num&#125;:16379 --name redis-$&#123;num&#125; \</span><br><span class="line">-v /opt/docker/redis/node-$&#123;num&#125;/data:/data \</span><br><span class="line">-v /opt/docker/redis/node-$&#123;num&#125;/conf/redis-cluster.conf:/etc/redis/redis-cluster.conf \</span><br><span class="line">-d --net redis-cluster --ip 172.20.0.1$&#123;num&#125; redis:latest redis-server /etc/redis/redis-cluster.conf</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>登录到任意一个节点</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis-1 /bin/bash</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>创建集群</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 172.20.0.11:6379 172.20.0.12:6379 172.20.0.13:6379 172.20.0.14:6379 172.20.0.15:6379 172.20.0.16:6379 --cluster-replicas 1 -a passwd</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示如下结果则创建成功</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span></span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 172.20.0.15:6379 to 172.20.0.11:6379</span><br><span class="line">Adding replica 172.20.0.16:6379 to 172.20.0.12:6379</span><br><span class="line">Adding replica 172.20.0.14:6379 to 172.20.0.13:6379</span><br><span class="line">M: a747f2e9db2cf7a6dd7f1c1b3435afb50cd56afc 172.20.0.11:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: a654e99f8d50e02bec40a4c4bff1999174ea1bab 172.20.0.12:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: f1c3f6806c24edafe92a9ee365dc7763dee59fc3 172.20.0.13:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 911fa7727f6fa76f1918c47ddd0a78fc9c7ae981 172.20.0.14:6379</span><br><span class="line">   replicates f1c3f6806c24edafe92a9ee365dc7763dee59fc3</span><br><span class="line">S: bdd7305a7d32e5f829c734da6a89b4a71d526ac4 172.20.0.15:6379</span><br><span class="line">   replicates a747f2e9db2cf7a6dd7f1c1b3435afb50cd56afc</span><br><span class="line">S: 94a5ab000fb64cfdb99049d55ccc6be42f13cda3 172.20.0.16:6379</span><br><span class="line">   replicates a654e99f8d50e02bec40a4c4bff1999174ea1bab</span><br><span class="line">Can I set the above configuration? (type &#x27;yes&#x27; to accept): yes</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER MEET messages to <span class="built_in">join</span> the cluster</span></span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 172.20.0.11:6379)</span></span><br><span class="line">M: a747f2e9db2cf7a6dd7f1c1b3435afb50cd56afc 172.20.0.11:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: a654e99f8d50e02bec40a4c4bff1999174ea1bab 172.20.0.12:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: f1c3f6806c24edafe92a9ee365dc7763dee59fc3 172.20.0.13:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 94a5ab000fb64cfdb99049d55ccc6be42f13cda3 172.20.0.16:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates a654e99f8d50e02bec40a4c4bff1999174ea1bab</span><br><span class="line">S: bdd7305a7d32e5f829c734da6a89b4a71d526ac4 172.20.0.15:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates a747f2e9db2cf7a6dd7f1c1b3435afb50cd56afc</span><br><span class="line">S: 911fa7727f6fa76f1918c47ddd0a78fc9c7ae981 172.20.0.14:6379</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates f1c3f6806c24edafe92a9ee365dc7763dee59fc3</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>登录到redis集群</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -p 6379 -a passwd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再进行高可用测试：设置一个key，观察key被存放到哪个槽，然后把该槽的主节点停掉，看看能否在获取到该key值</span></span><br></pre></td></tr></table></figure>

<h4 id="2）单机集群"><a href="#2）单机集群" class="headerlink" title="2）单机集群"></a>2）单机集群</h4><ul>
<li>集群说明：在同一台服务器上搭建redis集群，docker网络模式为host</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因为按照6.3.1~6.3.6的步骤搭建，只能在集群的机器上访问，仅适合在客户端与服务端在同一台服务器的情况，因为redis集群的网络为172.20.0.0/16，外网无法访问，因此采取host模式</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成6个节点的配置</span></span><br><span class="line">for port in $(seq 6371 6376); \</span><br><span class="line">do \</span><br><span class="line">mkdir -p /opt/docker/redis/node-$&#123;port&#125;/conf</span><br><span class="line">touch /opt/docker/redis/node-$&#123;port&#125;/conf/redis-cluster.conf</span><br><span class="line">cat &lt;&lt;&#x27;EOF&#x27;&gt;/opt/docker/redis/node-$&#123;port&#125;/conf/redis-cluster.conf</span><br><span class="line">port $&#123;port&#125;</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 192.168.199.140</span><br><span class="line">cluster-announce-port $&#123;port&#125;</span><br><span class="line">cluster-announce-bus-port 1$&#123;port&#125;</span><br><span class="line">appendonly yes</span><br><span class="line">masterauth passwd</span><br><span class="line">requirepass passwd</span><br><span class="line">EOF</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动6个节点的redis</span></span><br><span class="line">for port in $(seq 6371 6376); \</span><br><span class="line">do \</span><br><span class="line">docker run --name redis-$&#123;port&#125; \</span><br><span class="line">-v /opt/docker/redis/node-$&#123;port&#125;/data:/data \</span><br><span class="line">-v /opt/docker/redis/node-$&#123;port&#125;/conf/redis-cluster.conf:/etc/redis/redis-cluster.conf \</span><br><span class="line">-d --net=host --restart=always redis:latest redis-server /etc/redis/redis-cluster.conf</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录到任意一个节点</span></span><br><span class="line">docker exec -it redis-6371 /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建集群</span></span><br><span class="line">redis-cli --cluster create 192.168.199.140:6371 192.168.199.140:6372 192.168.199.140:6373 192.168.199.140:6374 192.168.199.140:6375 192.168.199.140:6376 --cluster-replicas 1 -a passwd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地连接测试</span></span><br><span class="line">redis-cli -c -a passwd -p 6371</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">远程连接测试</span></span><br><span class="line">redis-cli -c -a passwd -p 6374 -h 192.168.199.140</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群删除容器以及数据（慎重：只能在测试阶段执行）</span></span><br><span class="line">docker rm -f redis-6371 redis-6372 redis-6373 redis-6374 redis-6375 redis-6376 &amp;&amp; rm -rf /opt/docker/redis</span><br></pre></td></tr></table></figure>

<h4 id="3）多机集群（重点）"><a href="#3）多机集群（重点）" class="headerlink" title="3）多机集群（重点）"></a>3）多机集群（重点）</h4><ul>
<li>集群说明：在六台不同台服务器上搭建redis集群，docker网络模式为host，redis端口为6379，集群总线端口为16379，以下步骤均只需要在同一台机器执行</li>
</ul>
<ol>
<li>自动生成包含所有节点ip信息的cluster-ips文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/docker/redis &amp;&amp; cat &lt;&lt;&#x27;EOF&#x27;&gt;/opt/docker/redis/cluster-ips</span><br><span class="line">192.168.199.161</span><br><span class="line">192.168.199.162</span><br><span class="line">192.168.199.163</span><br><span class="line">192.168.199.164</span><br><span class="line">192.168.199.165</span><br><span class="line">192.168.199.166</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在任意一台机器上生成公私钥对</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -f /root/.ssh/id_rsa -N &#x27;&#x27;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>集群配置免密登录，需要输入对应机器的密码</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for ip in `cat /opt/docker/redis/cluster-ips`; do \</span><br><span class="line">ssh-copy-id $ip</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>集群安装rsync</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for ip in `cat /opt/docker/redis/cluster-ips`; do \</span><br><span class="line">ssh $ip &quot;yum -y install rsync&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>在该机器上将免密登录配置以及集群机器ip同步到其它服务器</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for ip in `cat /opt/docker/redis/cluster-ips`; do \</span><br><span class="line">rsync -av .ssh/ $ip:/root/.ssh</span><br><span class="line">rsync -av /opt/docker/redis/cluster-ips $ip:/opt/docker/redis/cluster-ips</span><br><span class="line">echo &quot;rsync $ip success.&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>集群启动端口、生成redis配置文件、运行redis容器</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">for ip in `cat /opt/docker/redis/cluster-ips`; do \</span><br><span class="line">ssh $ip &quot; \</span><br><span class="line">firewall-cmd --zone=public --add-port=6379/tcp --add-port=16379/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">mkdir -p /opt/docker/redis/node-$&#123;ip&#125;/conf</span><br><span class="line">touch /opt/docker/redis/node-$&#123;ip&#125;/conf/redis-cluster.conf</span><br><span class="line">cat &lt;&lt;&#x27;EOF&#x27;&gt;/opt/docker/redis/node-$&#123;ip&#125;/conf/redis-cluster.conf</span><br><span class="line">port 6379</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.$&#123;ip&#125;.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip $&#123;ip&#125;</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly yes</span><br><span class="line">masterauth passwd</span><br><span class="line">requirepass passwd</span><br><span class="line">EOF</span><br><span class="line">docker run --name redis-$&#123;ip&#125; \</span><br><span class="line">-v /opt/docker/redis/cluster-ips:/cluster-ips:ro \</span><br><span class="line">-v /opt/docker/redis/node-$&#123;ip&#125;/data:/data \</span><br><span class="line">-v /opt/docker/redis/node-$&#123;ip&#125;/conf/redis-cluster.conf:/etc/redis/redis-cluster.conf \</span><br><span class="line">-d --net=host --restart=always redis:latest redis-server /etc/redis/redis-cluster.conf</span><br><span class="line">&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">附：</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##############################单独生成容器并启动###############################</span></span></span><br><span class="line">for ip in `cat /opt/docker/redis/cluster-ips`; do \</span><br><span class="line">ssh $ip &quot; \</span><br><span class="line">docker run --name redis-$&#123;ip&#125; \</span><br><span class="line">-v /opt/docker/redis/cluster-ips:/cluster-ips:ro \</span><br><span class="line">-v /opt/docker/redis/node-$&#123;ip&#125;/data:/data \</span><br><span class="line">-v /opt/docker/redis/node-$&#123;ip&#125;/conf/redis-cluster.conf:/etc/redis/redis-cluster.conf \</span><br><span class="line">-d --net=host --restart=always redis:latest redis-server /etc/redis/redis-cluster.conf</span><br><span class="line">&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>创建集群</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录到任意一个节点</span></span><br><span class="line">docker exec -it redis-192.168.199.161 /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建集群</span></span><br><span class="line">redis-cli --cluster create `cat /cluster-ips|awk -F &#x27; &#x27; &#x27;&#123;printf $1&quot;:6379 &quot;&#125;&#x27;` --cluster-replicas 1 -a passwd</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地连接测试</span></span><br><span class="line">redis-cli -c -a passwd -p 6379</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">远程连接测试</span></span><br><span class="line">redis-cli -c -a passwd -p 6379 -h 192.168.199.166</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>集群命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群启动/停止/重启docker服务，可选值：start/stop/restart</span></span><br><span class="line">for ip in `cat /opt/docker/redis/cluster-ips`; do \</span><br><span class="line">ssh $ip &quot; \</span><br><span class="line">systemctl restart docker</span><br><span class="line">&quot;</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群启动/停止/重启docker中的redis服务，可选值：start/stop/restart</span></span><br><span class="line">for ip in `cat /opt/docker/redis/cluster-ips`; do \</span><br><span class="line">ssh $ip &quot; \</span><br><span class="line">docker restart redis-$&#123;ip&#125;</span><br><span class="line">&quot;</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群查看docker中的redis服务状态</span></span><br><span class="line">for ip in `cat /opt/docker/redis/cluster-ips`; do \</span><br><span class="line">ssh $ip &quot; \</span><br><span class="line">docker ps | grep redis-$&#123;ip&#125;</span><br><span class="line">&quot;</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群删除redis所有文件以及容器（慎重：只能在测试阶段执行）</span></span><br><span class="line">for ip in `cat /opt/docker/redis/cluster-ips`; do \</span><br><span class="line">ssh $ip &quot; \</span><br><span class="line">rm -rf /opt/docker/redis/node-$&#123;ip&#125;</span><br><span class="line">docker rm -f redis-$&#123;ip&#125;</span><br><span class="line">&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>10.群起脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;&#x27;EOF&#x27;&gt;/opt/docker/redis/redis-cluster.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保存redis所有节点ip的文件</span></span><br><span class="line">clusterIpsPath=/opt/docker/redis/cluster-ips</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">        start)</span><br><span class="line">                for ip in `cat $clusterIpsPath`; do \</span><br><span class="line">                ssh $ip &quot; \</span><br><span class="line">                docker start redis-$&#123;ip&#125;</span><br><span class="line">                &quot;</span><br><span class="line">                done</span><br><span class="line">                ;;</span><br><span class="line">        stop)</span><br><span class="line">                for ip in `cat $clusterIpsPath`; do \</span><br><span class="line">                ssh $ip &quot; \</span><br><span class="line">                docker stop redis-$&#123;ip&#125;</span><br><span class="line">                &quot;</span><br><span class="line">                done</span><br><span class="line">                ;;</span><br><span class="line">        restart)</span><br><span class="line">                for ip in `cat $clusterIpsPath`; do \</span><br><span class="line">                ssh $ip &quot; \</span><br><span class="line">                docker restart redis-$&#123;ip&#125;</span><br><span class="line">                &quot;</span><br><span class="line">                done</span><br><span class="line">                ;;</span><br><span class="line">        status)</span><br><span class="line">                for ip in `cat $clusterIpsPath`; do \</span><br><span class="line">                ssh $ip &quot; \</span><br><span class="line">                docker ps -a | grep redis-$&#123;ip&#125;</span><br><span class="line">                &quot;</span><br><span class="line">                done</span><br><span class="line">                ;;</span><br><span class="line">        restartDocker)</span><br><span class="line">                for ip in `cat $clusterIpsPath`; do \</span><br><span class="line">                ssh $ip &quot; \</span><br><span class="line">                systemctl restart docker</span><br><span class="line">                &quot;</span><br><span class="line">                done</span><br><span class="line">                ;;</span><br><span class="line">        *)</span><br><span class="line">                echo &quot;Usage: sh redis-cluster.sh start|stop|restart|status|restartDocker&quot;</span><br><span class="line">                ;;</span><br><span class="line">esac</span><br><span class="line">exit 0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>11.把群起脚本同步到所有节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for ip in `cat /opt/docker/redis/cluster-ips`; do \</span><br><span class="line">rsync -av /opt/docker/redis/redis-cluster.sh $ip:/opt/docker/redis/redis-cluster.sh</span><br><span class="line">echo &quot;rsync redis-cluster.sh to $ip success.&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h2 id="8-5-搭建zookeeper集群"><a href="#8-5-搭建zookeeper集群" class="headerlink" title="8.5 搭建zookeeper集群"></a>8.5 搭建zookeeper集群</h2><ol>
<li>拉取指定版本zookeeper</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull zookeeper:3.4.14</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建集群网络</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver bridge --gateway 172.30.0.1 --subnet 172.30.0.0/16 zk-cluster</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建并启动容器</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd -p 2181:2181 --name zk1 --net zk-cluster --ip 172.30.0.11 -v /opt/docker/zk1/conf:/conf -v /opt/docker/zk1/data:/data zookeeper:3.4.14</span><br><span class="line">docker run -itd -p 2182:2181 --name zk2 --net zk-cluster --ip 172.30.0.12 -v /opt/docker/zk2/conf:/conf -v /opt/docker/zk2/data:/data zookeeper:3.4.14</span><br><span class="line">docker run -itd -p 2183:2181 --name zk3 --net zk-cluster --ip 172.30.0.13 -v /opt/docker/zk3/conf:/conf -v /opt/docker/zk3/data:/data zookeeper:3.4.14</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>修改zoo.cfg，分别修改&#x2F;opt&#x2F;docker&#x2F;zk1&#x2F;conf&#x2F;zoo.cfg、&#x2F;opt&#x2F;docker&#x2F;zk2&#x2F;conf&#x2F;zoo.cfg、&#x2F;opt&#x2F;docker&#x2F;zk2&#x2F;conf&#x2F;zoo.cfg，增加如下配置：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/data</span><br><span class="line">server.1=172.30.0.11:2888:3888</span><br><span class="line">server.2=172.30.0.12:2888:3888</span><br><span class="line">server.3=172.30.0.13:2888:3888</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>修改myid，分别修改&#x2F;opt&#x2F;docker&#x2F;zk1&#x2F;data&#x2F;myid、&#x2F;opt&#x2F;docker&#x2F;zk2&#x2F;data&#x2F;myid、&#x2F;opt&#x2F;docker&#x2F;zk3&#x2F;data&#x2F;myid下内容为1、2、3</p>
</li>
<li><p>开启端口</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=2181/tcp --add-port=2182/tcp --add-port=2183/tcp -permanent &amp;&amp; firewall-cmd --reload &amp;&amp; firewall-cmd --list-ports</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>重启三个容器</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker restart zk1</span><br><span class="line">docker restart zk2</span><br><span class="line">docker restart zk3</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>查看容器状态</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it zk1 ./bin/zkServer.sh status &amp;&amp; docker exec -it zk2 ./bin/zkServer.sh status &amp;&amp; docker exec -it zk3 ./bin/zkServer.sh status</span><br></pre></td></tr></table></figure>

<h2 id="8-6-部署SpringBoot项目"><a href="#8-6-部署SpringBoot项目" class="headerlink" title="8.6 部署SpringBoot项目"></a>8.6 部署SpringBoot项目</h2><h3 id="8-6-1-docker-run"><a href="#8-6-1-docker-run" class="headerlink" title="8.6.1 docker run"></a>8.6.1 docker run</h3><h4 id="1）项目源码"><a href="#1）项目源码" class="headerlink" title="1）项目源码"></a>1）项目源码</h4><p>项目名：docker-test</p>
<ul>
<li>pom.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zhifei<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Application.java</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhifei.docker;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Application</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> He Zhifei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/4/12 14:57</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RestController</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InfoController</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(InfoController.class);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Autowired</span></span><br><span class="line">        <span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@GetMapping(&quot;/info&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">info</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">            <span class="comment">// application.yml中不配置端口时，通过Environment获取。</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;服务器信息 - &quot;</span> + getIp(request) + <span class="string">&quot;:&quot;</span> + env.getProperty(<span class="string">&quot;local.server.port&quot;</span>);</span><br><span class="line">            logger.info(msg);</span><br><span class="line">            <span class="keyword">return</span> msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取请求ip</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> request 请求</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> 请求ip</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getIp</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (request == <span class="literal">null</span>) &#123;</span><br><span class="line">                request = getRequest();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (request == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;x-forwarded-for&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (ipIsBlankOrUnknown(ip)) &#123;</span><br><span class="line">                ip = request.getHeader(<span class="string">&quot;Proxy-Client-IP&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ipIsBlankOrUnknown(ip)) &#123;</span><br><span class="line">                ip = request.getHeader(<span class="string">&quot;X-Forwarded-For&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ipIsBlankOrUnknown(ip)) &#123;</span><br><span class="line">                ip = request.getHeader(<span class="string">&quot;WL-Proxy-Client-IP&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ipIsBlankOrUnknown(ip)) &#123;</span><br><span class="line">                ip = request.getHeader(<span class="string">&quot;X-Real-IP&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ipIsBlankOrUnknown(ip)) &#123;</span><br><span class="line">                ip = request.getRemoteAddr();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;0:0:0:0:0:0:0:1&quot;</span>.equals(ip) ? <span class="string">&quot;127.0.0.1&quot;</span> : ip;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取HttpServletRequest</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> HttpServletRequest</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> HttpServletRequest <span class="title function_">getRequest</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 判断ip是否为空或者&quot;unknown&quot;</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ip</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">ipIsBlankOrUnknown</span><span class="params">(String ip)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在项目根目录下创建Dockerfile</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:8</span><br><span class="line">MAINTAINER hezhifei he-zhifei@foxmail.com</span><br><span class="line">WORKDIR /opt</span><br><span class="line">VOLUME /data</span><br><span class="line">ADD target/docker-test.jar app.jar</span><br><span class="line">EXPOSE 8080</span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;app.jar&quot;]</span><br></pre></td></tr></table></figure>

<h4 id="2）构建镜像"><a href="#2）构建镜像" class="headerlink" title="2）构建镜像"></a>2）构建镜像</h4><p>在服务器上拉取代码，进行打包，然后构建镜像。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd docker-test</span><br><span class="line">mvn package</span><br><span class="line">docker build -f Dockerfile -t harbor.loc/library/docker-test:v1.0.0 .</span><br></pre></td></tr></table></figure>

<h4 id="3）运行并测试"><a href="#3）运行并测试" class="headerlink" title="3）运行并测试"></a>3）运行并测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd -p 11000:8080 --name docker-test harbor.loc/library/docker-test:v1.0.0</span><br><span class="line">curl localhost:11000/info</span><br></pre></td></tr></table></figure>

<h4 id="4）推送镜像到harbor"><a href="#4）推送镜像到harbor" class="headerlink" title="4）推送镜像到harbor"></a>4）推送镜像到harbor</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录</span></span><br><span class="line">docker login harbor.loc -u admin -p Harbor12345</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推送</span></span><br><span class="line">docker push harbor.loc/library/docker-test:v1.0.0</span><br></pre></td></tr></table></figure>

<h3 id="8-6-2-docker-compose（多分片）"><a href="#8-6-2-docker-compose（多分片）" class="headerlink" title="8.6.2 docker compose（多分片）"></a>8.6.2 docker compose（多分片）</h3><h4 id="1）docker-compose-yml"><a href="#1）docker-compose-yml" class="headerlink" title="1）docker-compose.yml"></a>1）docker-compose.yml</h4><p>在项目根目录下创建docker-compose.yml，定义了docker-test、nginx容器的编排，以及容器网络。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">docker-test:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.loc/library/docker-test:v1.0.0</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">docker-test-net</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">&quot;no&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/data:/data</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">docker-test-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">12000</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">&quot;no&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker/nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker/nginx/logs:/var/log/nginx</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">docker-test</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">docker-test-net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>

<h4 id="2）修改nginx配置"><a href="#2）修改nginx配置" class="headerlink" title="2）修改nginx配置"></a>2）修改nginx配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/docker/nginx/conf.d &amp;&amp; cat &lt;&lt;&#x27;EOF&#x27;&gt;/opt/docker/nginx/conf.d/docker-test.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    listen  [::]:80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    #access_log  /var/log/nginx/host.access.log  main;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://docker-test:8080;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line">    </span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    proxy_pass   http://127.0.0.1;</span><br><span class="line">    #&#125;</span><br><span class="line">    </span><br><span class="line">    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">    #</span><br><span class="line">    #location ~ \.php$ &#123;</span><br><span class="line">    #    root           html;</span><br><span class="line">    #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">    #    fastcgi_index  index.php;</span><br><span class="line">    #    fastcgi_param  SCRIPT_FILENAME  /scripts;</span><br><span class="line">    #    include        fastcgi_params;</span><br><span class="line">    #&#125;</span><br><span class="line">    </span><br><span class="line">    # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">    # concurs with nginx&#x27;s one</span><br><span class="line">    #</span><br><span class="line">    #location ~ /\.ht &#123;</span><br><span class="line">    #    deny  all;</span><br><span class="line">    #&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h4 id="3）运行并测试-1"><a href="#3）运行并测试-1" class="headerlink" title="3）运行并测试"></a>3）运行并测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">up启动，down停止；--build启动前docker build；-d后台启动；--scale指定节点数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker-compose up [--build] [-d] [--scale &lt;服务名称&gt;=&lt;服务节点数&gt;]</span></span><br><span class="line">docker-compose up -d --scale docker-test=3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker-compose down时，会停止并移除容器，通过这种方式创建的网络也一并移除。</span></span><br><span class="line">[root@harbor docker-test]# docker-compose down</span><br><span class="line">Stopping docker-test_nginx_1       ... done</span><br><span class="line">Stopping docker-test_docker-test_1 ... done</span><br><span class="line">Stopping docker-test_docker-test_2 ... done</span><br><span class="line">Stopping docker-test_docker-test_3 ... done</span><br><span class="line">Removing docker-test_nginx_1       ... done</span><br><span class="line">Removing docker-test_docker-test_1 ... done</span><br><span class="line">Removing docker-test_docker-test_2 ... done</span><br><span class="line">Removing docker-test_docker-test_3 ... done</span><br><span class="line">Removing network docker-test_docker-test-net</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试</span></span><br><span class="line">curl localhost:12000/info</span><br></pre></td></tr></table></figure>

<h3 id="8-6-3-docker-swarm（多节点多分片）"><a href="#8-6-3-docker-swarm（多节点多分片）" class="headerlink" title="8.6.3 docker swarm（多节点多分片）"></a>8.6.3 docker swarm（多节点多分片）</h3><p>前提：</p>
<p>Ⅰ. 按照 [7.1 docker swarm（集群搭建）](# 7.1 docker swarm（集群搭建）) 把5台机器配置成集群，3个管理节点，2个工作节点。</p>
<p>Ⅱ. 所有节点都配置私服的hosts和私服的https证书，这个证书在 [8.1.2 harbor（推荐）](# 8.1.2 harbor（推荐）) 的第3点最后的“重点注意”第2小点有提及到。</p>
<h4 id="1）拉取镜像"><a href="#1）拉取镜像" class="headerlink" title="1）拉取镜像"></a>1）拉取镜像</h4><p>每个节点都拉取私服中的镜像，docker stack deploy拉取的镜像没有tag（tag显示为none），因此需要手动拉取。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull harbor.loc/library/docker-test:v1.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编排二用到nginx镜像</span></span><br><span class="line">docker pull nginx</span><br></pre></td></tr></table></figure>

<h4 id="2）stack-yml"><a href="#2）stack-yml" class="headerlink" title="2）stack.yml"></a>2）stack.yml</h4><p>在任意管理节点上编写stack.yml（数据卷的持久化目录需要提前创建，否则docker stack deploy会提示无此目录）：</p>
<ul>
<li>编排一：不用nginx，创建数据卷目录：mkdir -p &#x2F;opt&#x2F;data</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">docker-test:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.loc/library/docker-test:v1.0.0</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;13000:8080&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/data:/data</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编排二：结合nginx容器编排，创建数据卷目录：mkdir -p &#x2F;opt&#x2F;data &#x2F;opt&#x2F;docker&#x2F;nginx&#x2F;conf.d &#x2F;opt&#x2F;docker&#x2F;nginx&#x2F;logs</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">docker-test:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.loc/library/docker-test:v1.0.0</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">docker-test-net</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/data:/data</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">docker-test-net</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">13000</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker/nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/docker/nginx/logs:/var/log/nginx</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">docker-test</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">docker-test-net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">overlay</span></span><br></pre></td></tr></table></figure>

<h4 id="3）开放端口"><a href="#3）开放端口" class="headerlink" title="3）开放端口"></a>3）开放端口</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=13000/tcp --permanent &amp;&amp; firewall-cmd --reload &amp;&amp; firewall-cmd --list-ports</span><br></pre></td></tr></table></figure>

<h4 id="4）运行"><a href="#4）运行" class="headerlink" title="4）运行"></a>4）运行</h4><p>以下集群管理命令需要在管理节点上执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群启动或更新，-c指定stack.yml位置，不指定默认当前路径</span></span><br><span class="line">docker stack deploy -c stack.yml docker-test</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列出stack</span></span><br><span class="line">docker stack ls</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看指定stack中的services</span></span><br><span class="line">docker stack services &lt;stack名称&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有service</span></span><br><span class="line">docker service ls</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有节点分片的日志</span></span><br><span class="line">docker service logs &lt;日志id&gt;</span><br><span class="line">[root@localhost ~]# docker service logs --help</span><br><span class="line">Usage:  docker service logs [OPTIONS] SERVICE|TASK</span><br><span class="line">Fetch the logs of a service or task</span><br><span class="line">Options:</span><br><span class="line">      --details        Show extra details provided to logs</span><br><span class="line">  -f, --follow         Follow log output</span><br><span class="line">      --no-resolve     Do not map IDs to Names in output</span><br><span class="line">      --no-task-ids    Do not include task IDs in output</span><br><span class="line">      --no-trunc       Do not truncate output</span><br><span class="line">      --raw            Do not neatly format logs</span><br><span class="line">      --since string   Show logs since timestamp (e.g. 2013-01-02T13:23:37Z) or relative (e.g. 42m for 42 minutes)</span><br><span class="line">  -n, --tail string    Number of lines to show from the end of the logs (default &quot;all&quot;)</span><br><span class="line">  -t, --timestamps     Show timestamps</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看stack启动错误日志</span></span><br><span class="line">docker stack ps &lt;stack名称&gt; --no-trunc</span><br></pre></td></tr></table></figure>

<h4 id="5）测试"><a href="#5）测试" class="headerlink" title="5）测试"></a>5）测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可通过swarm集群任意节点访问，要用集群中任一具体IP，不要在服务器上直接用localhost访问。</span></span><br><span class="line">curl &lt;IP&gt;:13000/info</span><br></pre></td></tr></table></figure>




    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Docker/" rel="tag"># Docker</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/12/12/JVM%E4%BB%8B%E7%BB%8D%E4%B8%8E%E4%BC%98%E5%8C%96/" rel="prev" title="JVM介绍与优化">
                  <i class="fa fa-chevron-left"></i> JVM介绍与优化
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/07/10/GitLab+Jenkins%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2Vue%E9%A1%B9%E7%9B%AE/" rel="next" title="GitLab+Jenkins自动化部署Vue项目">
                  GitLab+Jenkins自动化部署Vue项目 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">he-zhifei</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">133k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">8:03</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span>总访客量</span>
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span>总访问量</span>
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="/js/my_js/canvas-nest.js"></script>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.0/comments.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.0/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.0/motion.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.0/next-boot.min.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.0/third-party/search/local-search.min.js"></script>




  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.0/third-party/pace.min.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"he-zhifei/blog-comments","issue_term":"pathname","theme":"github-light"}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.11.0/third-party/comments/utterances.min.js"></script>

</body>
</html>
